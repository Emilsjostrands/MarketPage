<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PortfÃ¶ljvy</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@300;400;500&family=Sora:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0b0d11;
  --s1: #111318;
  --s2: #181b22;
  --s3: #1f232d;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --accent: #b8f050;
  --accent-dim: rgba(184,240,80,0.12);
  --accent2: #50c8f0;
  --gold: #f0c050;
  --red: #f05060;
  --red-dim: rgba(240,80,96,0.12);
  --green-dim: rgba(184,240,80,0.08);
  --text: #dde0e8;
  --muted: #5a6070;
  --muted2: #7a8090;
  --sidebar-w: 240px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Sora',sans-serif;font-size:14px;display:flex;flex-direction:column;}

/* â”€â”€ TICKER â”€â”€ */
.ticker{background:var(--s1);border-bottom:1px solid var(--border);height:36px;overflow:hidden;display:flex;align-items:center;flex-shrink:0;}
.ticker-track{display:flex;animation:tick 40s linear infinite;white-space:nowrap;}
.ticker-track:hover{animation-play-state:paused;}
.t-item{padding:0 28px;font-family:'DM Mono',monospace;font-size:11px;display:flex;align-items:center;gap:8px;}
.t-sym{color:var(--muted2);}
.t-price{color:var(--text);}
.t-pos{color:var(--accent);}
.t-neg{color:var(--red);}
.t-div{color:var(--border2);padding:0 4px;}
@keyframes tick{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

/* â”€â”€ LAYOUT â”€â”€ */
.layout{display:flex;flex:1;overflow:hidden;}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{width:var(--sidebar-w);background:var(--s1);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;}
.sidebar-logo{padding:20px 20px 16px;border-bottom:1px solid var(--border);}
.logo-text{font-family:'Playfair Display',serif;font-size:18px;color:var(--accent);letter-spacing:0.01em;}
.logo-sub{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:0.15em;margin-top:3px;}
.sidebar-scroll{flex:1;overflow-y:auto;padding-bottom:16px;}
.sidebar-scroll::-webkit-scrollbar{width:3px;}
.sidebar-scroll::-webkit-scrollbar-thumb{background:var(--border2);}

.nav-section{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:0.15em;text-transform:uppercase;padding:16px 20px 6px;}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 20px;cursor:pointer;color:var(--muted2);font-size:13px;transition:all 0.15s;position:relative;border-left:2px solid transparent;}
.nav-item:hover{color:var(--text);background:var(--s2);}
.nav-item.active{color:var(--accent);background:var(--accent-dim);border-left-color:var(--accent);}
.nav-icon{font-size:13px;width:16px;text-align:center;flex-shrink:0;}
.nav-label{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.nav-flag{font-size:11px;}

/* Stock items in sidebar */
.stock-nav-item{display:flex;align-items:center;gap:9px;padding:7px 20px 7px 28px;cursor:pointer;color:var(--muted2);font-size:12px;transition:all 0.15s;border-left:2px solid transparent;position:relative;}
.stock-nav-item:hover{color:var(--text);background:var(--s2);}
.stock-nav-item.active{color:var(--accent);background:var(--accent-dim);border-left-color:var(--accent);}
.stock-nav-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.stock-nav-chg{font-family:'DM Mono',monospace;font-size:10px;flex-shrink:0;}

.add-stock-btn{display:flex;align-items:center;gap:8px;padding:7px 20px 7px 28px;cursor:pointer;color:var(--muted);font-size:12px;transition:all 0.15s;}
.add-stock-btn:hover{color:var(--accent);}

/* â”€â”€ MAIN â”€â”€ */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.content{flex:1;overflow-y:auto;padding:32px 36px;}
.content::-webkit-scrollbar{width:4px;}
.content::-webkit-scrollbar-thumb{background:var(--border2);}

/* â”€â”€ PAGES â”€â”€ */
.page{display:none;}
.page.active{display:block;animation:fadeIn 0.2s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

.page-header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:28px;}
.page-title{font-family:'Playfair Display',serif;font-size:26px;font-weight:400;line-height:1.2;}
.page-title small{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);display:block;margin-bottom:4px;letter-spacing:0.1em;text-transform:uppercase;}
.page-meta{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);text-align:right;line-height:1.7;}

/* â”€â”€ STATS â”€â”€ */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
.stat{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:18px;}
.stat-label{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:8px;}
.stat-val{font-size:22px;font-weight:500;letter-spacing:-0.02em;line-height:1;}
.stat-sub{font-family:'DM Mono',monospace;font-size:10px;margin-top:5px;color:var(--muted2);}
.pos{color:var(--accent);}
.neg{color:var(--red);}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:22px;margin-bottom:18px;}
.card-title{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:16px;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:18px;}

/* â”€â”€ TABLE â”€â”€ */
.htable{width:100%;border-collapse:collapse;}
.htable th{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;padding:0 0 10px;text-align:left;border-bottom:1px solid var(--border);}
.htable th:not(:first-child){text-align:right;}
.htable td{padding:10px 0;border-bottom:1px solid var(--border);font-size:12px;}
.htable td:not(:first-child){text-align:right;font-family:'DM Mono',monospace;font-size:11px;}
.htable tr:last-child td{border-bottom:none;}
.htable tr{cursor:pointer;transition:background 0.1s;}
.htable tr:hover td{background:var(--s2);}
.sn{font-weight:500;font-size:13px;}
.st{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-top:2px;}

/* â”€â”€ CHART â”€â”€ */
.chart-area{height:100px;display:flex;align-items:flex-end;gap:2px;margin-top:8px;}
.bar{border-radius:2px 2px 0 0;flex:1;transition:all 0.2s;background:var(--s3);}
.bar:hover{background:rgba(184,240,80,0.5);}
.bar.hi{background:rgba(184,240,80,0.35);}

/* â”€â”€ NEWS â”€â”€ */
.news-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.badge{font-family:'DM Mono',monospace;font-size:10px;background:var(--s2);border:1px solid var(--border);padding:6px 14px;border-radius:20px;color:var(--muted2);}
.btn-row{display:flex;gap:8px;}
.btn{background:var(--accent);color:#0b0d11;border:none;padding:8px 18px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Sora',sans-serif;transition:opacity 0.15s;}
.btn:hover{opacity:0.85;}
.btn-ghost{background:transparent;color:var(--muted2);border:1px solid var(--border);padding:8px 14px;border-radius:7px;font-size:12px;cursor:pointer;font-family:'Sora',sans-serif;transition:all 0.15s;}
.btn-ghost:hover{border-color:var(--border2);color:var(--text);}

.news-item{border:1px solid var(--border);border-radius:10px;padding:18px;margin-bottom:12px;background:var(--s1);transition:border-color 0.2s,transform 0.15s;}
.news-item:hover{border-color:rgba(184,240,80,0.25);transform:translateY(-1px);}
.ni-top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:8px;}
.ni-title{font-size:13px;font-weight:500;line-height:1.4;flex:1;}
.impact{font-family:'DM Mono',monospace;font-size:9px;padding:3px 10px;border-radius:20px;white-space:nowrap;flex-shrink:0;}
.imp-h{background:rgba(240,80,96,0.15);color:var(--red);border:1px solid rgba(240,80,96,0.3);}
.imp-m{background:rgba(240,192,80,0.15);color:var(--gold);border:1px solid rgba(240,192,80,0.3);}
.imp-l{background:rgba(184,240,80,0.1);color:var(--accent);border:1px solid rgba(184,240,80,0.2);}
.ni-body{font-size:12px;color:var(--muted2);line-height:1.65;margin-bottom:10px;}
.tags{display:flex;gap:6px;flex-wrap:wrap;}
.tag{font-family:'DM Mono',monospace;font-size:9px;background:var(--s2);border:1px solid var(--border);padding:3px 9px;border-radius:4px;color:var(--muted2);}

/* â”€â”€ STOCK PAGE â”€â”€ */
.stock-hero{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:24px 28px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:flex-start;}
.sh-left{}
.sh-name{font-family:'Playfair Display',serif;font-size:28px;font-weight:400;}
.sh-meta{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted2);margin-top:4px;display:flex;gap:16px;}
.sh-right{text-align:right;}
.sh-price{font-family:'DM Mono',monospace;font-size:28px;font-weight:500;letter-spacing:-0.02em;}
.sh-change{font-family:'DM Mono',monospace;font-size:13px;margin-top:4px;}

.editor-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:20px;}
.etab{padding:10px 18px;font-size:12px;color:var(--muted2);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.15s;}
.etab:hover{color:var(--text);}
.etab.active{color:var(--accent);border-bottom-color:var(--accent);}

.editor-content{display:none;}
.editor-content.active{display:block;}

.note-editor{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:16px;min-height:180px;font-size:13px;line-height:1.75;color:var(--text);outline:none;width:100%;font-family:'Sora',sans-serif;resize:vertical;}
.note-editor:focus{border-color:rgba(184,240,80,0.3);}

.save-bar{display:flex;justify-content:space-between;align-items:center;margin-top:12px;}
.save-hint{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);}

.info-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.info-cell{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:14px;}
.ic-label{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:6px;}
.ic-val{font-size:14px;font-weight:500;}
.ic-input{background:transparent;border:none;color:var(--text);font-size:14px;font-weight:500;font-family:'Sora',sans-serif;width:100%;outline:none;}

.tag-editor{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.tag-editable{font-family:'DM Mono',monospace;font-size:10px;padding:4px 12px;border-radius:4px;background:var(--accent-dim);border:1px solid rgba(184,240,80,0.25);color:var(--accent);cursor:pointer;transition:all 0.15s;display:flex;align-items:center;gap:6px;}
.tag-editable:hover .tag-x{opacity:1;}
.tag-x{opacity:0;font-size:11px;transition:opacity 0.15s;}
.tag-add-input{background:transparent;border:1px dashed var(--border2);border-radius:4px;padding:4px 10px;font-family:'DM Mono',monospace;font-size:10px;color:var(--muted2);outline:none;width:100px;font-family:'DM Mono',monospace;}
.tag-add-input:focus{border-color:rgba(184,240,80,0.3);color:var(--text);}

/* â”€â”€ ADD STOCK MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity 0.2s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--s1);border:1px solid var(--border2);border-radius:14px;padding:28px;width:380px;transform:translateY(10px);transition:transform 0.2s;}
.modal-overlay.open .modal{transform:translateY(0);}
.modal-title{font-family:'Playfair Display',serif;font-size:20px;margin-bottom:20px;}
.modal label{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;display:block;margin-bottom:6px;margin-top:14px;}
.modal input, .modal select{width:100%;background:var(--s2);border:1px solid var(--border2);border-radius:7px;padding:10px 12px;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;outline:none;transition:border-color 0.15s;}
.modal input:focus, .modal select:focus{border-color:rgba(184,240,80,0.4);}
.modal select option{background:var(--s2);}
.modal-btns{display:flex;gap:10px;margin-top:22px;}
.modal-btns .btn{flex:1;}
.modal-btns .btn-ghost{flex:1;}

/* â”€â”€ PORTFOLIO LIST â”€â”€ */
.portfolio-list-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;}
.plc{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:18px;cursor:pointer;transition:all 0.2s;}
.plc:hover{border-color:rgba(184,240,80,0.3);transform:translateY(-2px);}
.plc-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;}
.plc-name{font-weight:500;font-size:14px;}
.plc-ticker{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted2);margin-top:2px;}
.plc-price{font-family:'DM Mono',monospace;font-size:13px;text-align:right;}
.plc-notes{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.5;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.plc-add{display:flex;align-items:center;justify-content:center;border-style:dashed;color:var(--muted);font-size:13px;}
.plc-add:hover{color:var(--accent);border-color:rgba(184,240,80,0.3);}
</style>
</head>
<body>

<!-- TICKER -->
<div class="ticker">
  <div class="ticker-track" id="tickerTrack"></div>
</div>

<!-- LAYOUT -->
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-text">PortfÃ¶ljvy</div>
      <div class="logo-sub">Dina investeringar</div>
    </div>
    <div class="sidebar-scroll">

      <div class="nav-section">Ã–versikt</div>
      <div class="nav-item active" onclick="nav('dashboard',this)">
        <span class="nav-icon">â—ˆ</span><span class="nav-label">Dashboard</span>
      </div>
      <div class="nav-item" onclick="nav('news',this)">
        <span class="nav-icon">â—</span><span class="nav-label">Nyheter Â· Onepager</span>
      </div>

      <div class="nav-section">PortfÃ¶lj</div>
      <div class="nav-item" onclick="nav('portfolio',this)">
        <span class="nav-icon">â–¦</span><span class="nav-label">Alla bolag</span>
      </div>

      <!-- Dynamic stock items -->
      <div id="stockNavItems"></div>

      <div class="add-stock-btn" onclick="openModal()">
        <span style="font-size:16px;line-height:1;">+</span>
        <span>LÃ¤gg till bolag</span>
      </div>

    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">
    <div class="content">

      <!-- DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <div class="page-header">
          <div class="page-title"><small>VÃ¤lkommen tillbaka</small>Dashboard</div>
          <div class="page-meta" id="dashDate"></div>
        </div>
        <div class="stats-row">
          <div class="stat">
            <div class="stat-label">PortfÃ¶ljvÃ¤rde</div>
            <div class="stat-val" id="totalValue">â€”</div>
            <div class="stat-sub">Totalt bokfÃ¶rt vÃ¤rde</div>
          </div>
          <div class="stat">
            <div class="stat-label">Antal innehav</div>
            <div class="stat-val" id="holdingCount">0</div>
            <div class="stat-sub" id="holdingBreak">â€”</div>
          </div>
          <div class="stat">
            <div class="stat-label">Aktiva analyser</div>
            <div class="stat-val" id="noteCount">0</div>
            <div class="stat-sub">Med anteckningar</div>
          </div>
          <div class="stat">
            <div class="stat-label">Senast uppdaterad</div>
            <div class="stat-val" style="font-size:16px;" id="lastUpdated">â€”</div>
            <div class="stat-sub">Manuell kurs</div>
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <div class="card-title">Innehav Â· Snabbvy</div>
            <table class="htable" id="dashTable">
              <thead><tr>
                <th>Bolag</th><th>Kurs</th><th>Notering</th><th>BÃ¶rsvÃ¤rde</th>
              </tr></thead>
              <tbody id="dashTableBody"></tbody>
            </table>
          </div>
          <div class="card">
            <div class="card-title">PortfÃ¶ljsammansÃ¤ttning</div>
            <div class="chart-area" id="chartBars"></div>
          </div>
        </div>
      </div>

      <!-- NEWS -->
      <div class="page" id="page-news">
        <div class="page-header">
          <div class="page-title"><small>AI-genererad</small>Nyheter Â· Onepager</div>
          <div class="page-meta" id="newsDate"></div>
        </div>
        <div class="news-controls">
          <div class="badge" id="newsBadge">Klicka pÃ¥ "Generera" fÃ¶r att hÃ¤mta dagens nyheter</div>
          <div class="btn-row">
            <button class="btn-ghost">Exportera PDF</button>
            <button class="btn" onclick="generateNews()">âŸ³ &nbsp;Generera nyheter</button>
          </div>
        </div>
        <div id="newsContent">
          <div style="text-align:center;padding:60px 20px;color:var(--muted);">
            <div style="font-size:32px;margin-bottom:12px;">â—</div>
            <div style="font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.1em;">Inga nyheter genererade Ã¤nnu</div>
            <div style="font-size:12px;margin-top:8px;color:var(--muted);">LÃ¤gg till bolag i portfÃ¶ljen och tryck pÃ¥ "Generera nyheter"</div>
          </div>
        </div>
      </div>

      <!-- PORTFOLIO LIST -->
      <div class="page" id="page-portfolio">
        <div class="page-header">
          <div class="page-title"><small>PortfÃ¶lj</small>Alla bolag</div>
          <button class="btn" onclick="openModal()">+ LÃ¤gg till bolag</button>
        </div>
        <div class="portfolio-list-grid" id="portfolioGrid"></div>
      </div>

      <!-- STOCK DETAIL -->
      <div class="page" id="page-stock">
        <div id="stockDetailContent"></div>
      </div>

    </div>
  </div>
</div>

<!-- ADD STOCK MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-title">LÃ¤gg till bolag</div>
    <label>Bolagsnamn</label>
    <input type="text" id="m-name" placeholder="t.ex. Ericsson">
    <label>Ticker / Symbol</label>
    <input type="text" id="m-ticker" placeholder="t.ex. ERIC B">
    <label>BÃ¶rs</label>
    <select id="m-exchange">
      <option value="StockholmsbÃ¶rsen ğŸ‡¸ğŸ‡ª">StockholmsbÃ¶rsen ğŸ‡¸ğŸ‡ª</option>
      <option value="NASDAQ ğŸ‡ºğŸ‡¸">NASDAQ ğŸ‡ºğŸ‡¸</option>
      <option value="NYSE ğŸ‡ºğŸ‡¸">NYSE ğŸ‡ºğŸ‡¸</option>
      <option value="Annan">Annan</option>
    </select>
    <label>Aktuell kurs (valfritt)</label>
    <input type="text" id="m-price" placeholder="t.ex. 80.42">
    <div class="modal-btns">
      <button class="btn-ghost" onclick="closeModal()">Avbryt</button>
      <button class="btn" onclick="addStock()">LÃ¤gg till</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ STATE â”€â”€
let stocks = [];
let activeStockId = null;
let currentNavEl = null;

// Load from storage
async function loadData() {
  try {
    const r = await window.storage.get('portfoljapp-stocks');
    if (r) stocks = JSON.parse(r.value);
  } catch(e) { stocks = []; }
  renderAll();
}

async function saveData() {
  try { await window.storage.set('portfoljapp-stocks', JSON.stringify(stocks)); } catch(e){}
}

// â”€â”€ TICKER â”€â”€
const TICKER_DATA = [
  {sym:'ERIC B', price:'80.42', chg:'+1.2%', pos:true},
  {sym:'INVE A', price:'212.60', chg:'-0.4%', pos:false},
  {sym:'SEB A', price:'143.85', chg:'+0.8%', pos:true},
  {sym:'AAPL', price:'$228.40', chg:'+0.3%', pos:true},
  {sym:'NVDA', price:'$892.10', chg:'+2.1%', pos:true},
  {sym:'MSFT', price:'$415.30', chg:'-0.2%', pos:false},
  {sym:'OMXS30', price:'2 340.5', chg:'+0.5%', pos:true},
  {sym:'HM B', price:'148.20', chg:'-1.1%', pos:false},
  {sym:'USD/SEK', price:'10.42', chg:'+0.1%', pos:true},
];
function buildTicker() {
  const t = document.getElementById('tickerTrack');
  const items = [...TICKER_DATA, ...TICKER_DATA];
  t.innerHTML = items.map(d=>`
    <div class="t-item">
      <span class="t-sym">${d.sym}</span>
      <span class="t-price">${d.price}</span>
      <span class="${d.pos?'t-pos':'t-neg'}">${d.chg}</span>
    </div><span class="t-div">Â·</span>
  `).join('');
}

// â”€â”€ NAV â”€â”€
function nav(page, el) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.querySelectorAll('.nav-item,.stock-nav-item').forEach(n=>n.classList.remove('active'));
  if(el){ el.classList.add('active'); currentNavEl=el; }
  if(page==='dashboard') renderDashboard();
  if(page==='portfolio') renderPortfolioGrid();
  if(page==='news') renderNewsDate();
}

function navToStock(id, el) {
  activeStockId = id;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-stock').classList.add('active');
  document.querySelectorAll('.nav-item,.stock-nav-item').forEach(n=>n.classList.remove('active'));
  if(el) el.classList.add('active');
  renderStockPage(id);
}

// â”€â”€ RENDER SIDEBAR STOCKS â”€â”€
function renderSidebarStocks() {
  const container = document.getElementById('stockNavItems');
  container.innerHTML = stocks.map(s => `
    <div class="stock-nav-item ${activeStockId===s.id?'active':''}" onclick="navToStock('${s.id}',this)">
      <span class="nav-flag">${s.exchange.includes('ğŸ‡¸ğŸ‡ª')?'ğŸ‡¸ğŸ‡ª':'ğŸ‡ºğŸ‡¸'}</span>
      <span class="stock-nav-name">${s.name}</span>
      <span class="stock-nav-chg ${s.price?'pos':''}">${s.price||''}</span>
    </div>
  `).join('');
}

// â”€â”€ DASHBOARD â”€â”€
function renderDashboard() {
  // Date
  const now = new Date();
  document.getElementById('dashDate').innerHTML = now.toLocaleDateString('sv-SE',{weekday:'long',year:'numeric',month:'long',day:'numeric'}).toUpperCase();
  document.getElementById('newsDate').innerHTML = now.toLocaleDateString('sv-SE',{day:'numeric',month:'long',year:'numeric'}).toUpperCase();

  const se = stocks.filter(s=>s.exchange.includes('ğŸ‡¸ğŸ‡ª')).length;
  const us = stocks.filter(s=>!s.exchange.includes('ğŸ‡¸ğŸ‡ª')).length;
  document.getElementById('holdingCount').textContent = stocks.length;
  document.getElementById('holdingBreak').textContent = `${se} SE Â· ${us} US`;
  const withNotes = stocks.filter(s=>s.notes && s.notes.trim().length>10).length;
  document.getElementById('noteCount').textContent = withNotes;
  document.getElementById('lastUpdated').textContent = now.toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit'});

  // Table
  const tbody = document.getElementById('dashTableBody');
  if(stocks.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--muted);">Inga bolag Ã¤nnu â€” lÃ¤gg till via menyn</td></tr>`;
    document.getElementById('totalValue').textContent = '0 kr';
  } else {
    tbody.innerHTML = stocks.map(s=>`
      <tr onclick="navToStock('${s.id}')">
        <td><div class="sn">${s.exchange.includes('ğŸ‡¸ğŸ‡ª')?'ğŸ‡¸ğŸ‡ª':'ğŸ‡ºğŸ‡¸'} ${s.name}</div><div class="st">${s.ticker}</div></td>
        <td>${s.price||'â€”'}</td>
        <td style="font-size:10px;color:var(--muted2)">${s.exchange.replace(/ğŸ‡¸ğŸ‡ª|ğŸ‡ºğŸ‡¸/g,'').trim()}</td>
        <td>â€”</td>
      </tr>
    `).join('');
    document.getElementById('totalValue').textContent = 'â€”';
  }

  // Chart bars
  const chart = document.getElementById('chartBars');
  const vals = [55,60,57,65,62,70,68,75,72,80,77,82,80,88,84,92,88,95,91,98,94,100,97,103];
  chart.innerHTML = vals.map((v,i)=>{
    const mn=Math.min(...vals),mx=Math.max(...vals);
    const h = ((v-mn)/(mx-mn)*70+12).toFixed(1);
    return `<div class="bar ${i===vals.length-1?'hi':''}" style="height:${h}px"></div>`;
  }).join('');
}

// â”€â”€ PORTFOLIO GRID â”€â”€
function renderPortfolioGrid() {
  const g = document.getElementById('portfolioGrid');
  const cards = stocks.map(s=>`
    <div class="plc" onclick="navToStock('${s.id}')">
      <div class="plc-top">
        <div>
          <div class="plc-name">${s.exchange.includes('ğŸ‡¸ğŸ‡ª')?'ğŸ‡¸ğŸ‡ª':'ğŸ‡ºğŸ‡¸'} ${s.name}</div>
          <div class="plc-ticker">${s.ticker} Â· ${s.exchange.replace(/ğŸ‡¸ğŸ‡ª|ğŸ‡ºğŸ‡¸/g,'').trim()}</div>
        </div>
        <div class="plc-price pos">${s.price||'â€”'}</div>
      </div>
      <div class="plc-notes">${s.notes ? s.notes.substring(0,80)+'...' : 'Inga anteckningar Ã¤nnu'}</div>
    </div>
  `).join('');
  g.innerHTML = cards + `<div class="plc plc-add" onclick="openModal()">+ LÃ¤gg till bolag</div>`;
}

// â”€â”€ STOCK PAGE â”€â”€
function renderStockPage(id) {
  const s = stocks.find(x=>x.id===id);
  if(!s) return;
  const flag = s.exchange.includes('ğŸ‡¸ğŸ‡ª')?'ğŸ‡¸ğŸ‡ª':'ğŸ‡ºğŸ‡¸';
  document.getElementById('stockDetailContent').innerHTML = `
    <div class="stock-hero">
      <div class="sh-left">
        <div class="sh-name">${flag} ${s.name}</div>
        <div class="sh-meta">
          <span>${s.ticker}</span>
          <span>Â·</span>
          <span>${s.exchange}</span>
          ${s.sector?`<span>Â·</span><span>${s.sector}</span>`:''}
        </div>
      </div>
      <div class="sh-right">
        <div class="sh-price">${s.price||'â€”'}</div>
        <div class="sh-change pos">Uppdatera kurs nedan</div>
      </div>
    </div>

    <div class="editor-tabs">
      <div class="etab active" onclick="switchTab('notes',this)">ğŸ“ Anteckningar</div>
      <div class="etab" onclick="switchTab('bull',this)">â†‘ Bull-case</div>
      <div class="etab" onclick="switchTab('bear',this)">â†“ Bear-case</div>
      <div class="etab" onclick="switchTab('info',this)">â—ˆ Nyckeltal</div>
      <div class="etab" onclick="switchTab('sources',this)">âŠ KÃ¤llor</div>
    </div>

    <div class="editor-content active" id="tab-notes">
      <textarea class="note-editor" id="note-main" placeholder="Skriv dina anteckningar och analys om ${s.name} hÃ¤r...">${s.notes||''}</textarea>
      <div class="save-bar">
        <span class="save-hint" id="save-hint-notes">Osparad</span>
        <button class="btn" onclick="saveNote('notes')">Spara</button>
      </div>
      <div class="tag-editor" id="tagEditor">
        ${(s.tags||[]).map(t=>`<div class="tag-editable" onclick="removeTag('${id}','${t}')">${t}<span class="tag-x">Ã—</span></div>`).join('')}
        <input class="tag-add-input" placeholder="+ Ny tagg" id="tagInput" onkeydown="handleTagInput(event,'${id}')">
      </div>
    </div>

    <div class="editor-content" id="tab-bull">
      <textarea class="note-editor" id="note-bull" placeholder="VarfÃ¶r Ã¤r det ett kÃ¶plÃ¤ge? Vilka katalysatorer finns? Vad Ã¤r uppsidan?">${s.bull||''}</textarea>
      <div class="save-bar">
        <span class="save-hint" id="save-hint-bull">Osparad</span>
        <button class="btn" onclick="saveNote('bull')">Spara</button>
      </div>
    </div>

    <div class="editor-content" id="tab-bear">
      <textarea class="note-editor" id="note-bear" placeholder="Vilka risker finns? Vad kan gÃ¥ fel? Vad Ã¤r nedsidan?">${s.bear||''}</textarea>
      <div class="save-bar">
        <span class="save-hint" id="save-hint-bear">Osparad</span>
        <button class="btn" onclick="saveNote('bear')">Spara</button>
      </div>
    </div>

    <div class="editor-content" id="tab-info">
      <div class="info-grid">
        ${[
          ['Aktuell kurs','price',s.price||''],
          ['P/E-tal','pe',s.pe||''],
          ['Direktavkastning','yield',s.yield||''],
          ['BÃ¶rsvÃ¤rde','marketcap',s.marketcap||''],
          ['Sektor','sector',s.sector||''],
          ['Antal aktier','shares',s.shares||''],
        ].map(([label,key,val])=>`
          <div class="info-cell">
            <div class="ic-label">${label}</div>
            <input class="ic-input" value="${val}" placeholder="â€”" onchange="updateField('${id}','${key}',this.value)">
          </div>
        `).join('')}
      </div>
      <div style="margin-top:14px">
        <button class="btn" onclick="saveFields()">Spara nyckeltal</button>
      </div>
    </div>

    <div class="editor-content" id="tab-sources">
      <textarea class="note-editor" id="note-sources" placeholder="Klistra in lÃ¤nkar, rapporter, analyser eller anteckna var du hittat din information...">${s.sources||''}</textarea>
      <div class="save-bar">
        <span class="save-hint" id="save-hint-sources">Osparad</span>
        <button class="btn" onclick="saveNote('sources')">Spara</button>
      </div>
    </div>
  `;
}

function switchTab(name, el) {
  document.querySelectorAll('.etab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.editor-content').forEach(c=>c.classList.remove('active'));
  if(el) el.classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');
}

function saveNote(field) {
  const s = stocks.find(x=>x.id===activeStockId);
  if(!s) return;
  const fieldMap = {notes:'note-main',bull:'note-bull',bear:'note-bear',sources:'note-sources'};
  s[field] = document.getElementById(fieldMap[field]).value;
  saveData();
  renderSidebarStocks();
  const hint = document.getElementById('save-hint-'+field);
  if(hint){ hint.textContent = 'Sparad âœ“'; hint.style.color='var(--accent)'; setTimeout(()=>{hint.textContent='Osparad';hint.style.color='';},2000); }
}

function updateField(id, key, val) {
  const s = stocks.find(x=>x.id===id);
  if(s) s[key] = val;
}
function saveFields() {
  saveData();
  renderSidebarStocks();
}

function handleTagInput(e, id) {
  if(e.key==='Enter' || e.key===',') {
    e.preventDefault();
    const val = e.target.value.trim().replace(',','');
    if(!val) return;
    const s = stocks.find(x=>x.id===id);
    if(!s.tags) s.tags=[];
    if(!s.tags.includes(val)) { s.tags.push(val); saveData(); renderStockPage(id); }
    e.target.value='';
  }
}
function removeTag(id, tag) {
  const s = stocks.find(x=>x.id===id);
  if(s && s.tags) { s.tags = s.tags.filter(t=>t!==tag); saveData(); renderStockPage(id); }
}

// â”€â”€ MODAL â”€â”€
function openModal() { document.getElementById('modalOverlay').classList.add('open'); document.getElementById('m-name').focus(); }
function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }

function addStock() {
  const name = document.getElementById('m-name').value.trim();
  const ticker = document.getElementById('m-ticker').value.trim().toUpperCase();
  const exchange = document.getElementById('m-exchange').value;
  const price = document.getElementById('m-price').value.trim();
  if(!name || !ticker) return;
  const stock = {
    id: 'stock-'+Date.now(),
    name, ticker, exchange, price,
    notes:'', bull:'', bear:'', sources:'',
    tags:[], pe:'', yield:'', marketcap:'', sector:'', shares:''
  };
  stocks.push(stock);
  saveData();
  closeModal();
  document.getElementById('m-name').value='';
  document.getElementById('m-ticker').value='';
  document.getElementById('m-price').value='';
  renderAll();
  navToStock(stock.id);
}

// â”€â”€ NEWS â”€â”€
function renderNewsDate() {
  const now = new Date();
  document.getElementById('newsDate').innerHTML = now.toLocaleDateString('sv-SE',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).toUpperCase();
}

function generateNews() {
  if(stocks.length === 0) {
    document.getElementById('newsContent').innerHTML = `<div style="text-align:center;padding:40px;color:var(--muted);font-size:13px;">LÃ¤gg till bolag i portfÃ¶ljen fÃ¶rst!</div>`;
    return;
  }
  const names = stocks.map(s=>s.name+' ('+s.ticker+')').join(', ');
  document.getElementById('newsBadge').textContent = 'Genererar nyheter med AI...';
  document.getElementById('newsContent').innerHTML = `<div style="text-align:center;padding:60px;color:var(--muted);"><div style="font-size:24px;margin-bottom:12px;animation:spin 1s linear infinite;display:inline-block;">â—Œ</div><br>HÃ¤mtar nyheter fÃ¶r ${stocks.length} bolag...</div>`;

  // Demo news (in a real version this would call Claude API)
  setTimeout(()=>{
    const now = new Date();
    document.getElementById('newsBadge').textContent = `Genererad ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')} Â· ${stocks.length} bolag bevakade`;
    const demoNews = [
      {title:`Makro: Federal Reserve hÃ¥ller rÃ¤ntan ofÃ¶rÃ¤ndrad`, body:`Fed-protokoll visar splittrad syn pÃ¥ takten fÃ¶r kommande rÃ¤ntejusteringar. PÃ¥verkar riskaptit fÃ¶r tillvÃ¤xtaktier globalt. Direkt relevant fÃ¶r dina eventuella US-innehav.`, impact:'imp-h', label:'HÃ–G PÃ…VERKAN', tags:['Makro','USD','RÃ¤nta']},
      {title:`Tekniksektorn: Stark AI-efterfrÃ¥gan hÃ¥ller i sig under Q1 2026`, body:`Analytiker pÃ¥ Morgan Stanley rapporterar att AI-investeringarna frÃ¥n hyperscalers fortsÃ¤tter accelerera. Positivt fÃ¶r bolag exponerade mot datacenter och halvledare.`, impact:'imp-m', label:'MEDEL PÃ…VERKAN', tags:['AI','Tech','Halvledare']},
      {title:`Svensk ekonomi: Riksbanken signalerar mÃ¶jlig rÃ¤ntesÃ¤nkning i april`, body:`Riksbankens vice riksbankschef antyder att inflationsdatan Ã¶ppnar fÃ¶r sÃ¤nkning under vÃ¥ren. Gynnar rÃ¤ntekÃ¤nsliga bolag pÃ¥ StockholmsbÃ¶rsen.`, impact:'imp-l', label:'POSITIV SIGNAL', tags:['Riksbanken','Makro','Sverige']},
    ];
    document.getElementById('newsContent').innerHTML = demoNews.map(n=>`
      <div class="news-item">
        <div class="ni-top">
          <div class="ni-title">${n.title}</div>
          <div class="impact ${n.impact}">${n.label}</div>
        </div>
        <div class="ni-body">${n.body}</div>
        <div class="tags">${n.tags.map(t=>`<span class="tag">${t}</span>`).join('')}
        ${stocks.slice(0,3).map(s=>`<span class="tag">${s.ticker}</span>`).join('')}</div>
      </div>
    `).join('');
  }, 1800);
}

// â”€â”€ RENDER ALL â”€â”€
function renderAll() {
  renderSidebarStocks();
  renderDashboard();
}

// â”€â”€ CLOSE MODAL ON OUTSIDE CLICK â”€â”€
document.getElementById('modalOverlay').addEventListener('click', e => {
  if(e.target === document.getElementById('modalOverlay')) closeModal();
});

// â”€â”€ KEYBOARD SHORTCUT: Escape to close modal â”€â”€
document.addEventListener('keydown', e => {
  if(e.key==='Escape') closeModal();
});

// â”€â”€ INIT â”€â”€
document.getElementById('dashDate').innerHTML = new Date().toLocaleDateString('sv-SE',{weekday:'long',year:'numeric',month:'long',day:'numeric'}).toUpperCase();
buildTicker();
loadData();
</script>
</body>
</html>
