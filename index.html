<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portf√∂ljvy</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@300;400;500&family=Sora:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0d11;--s1:#111318;--s2:#181b22;--s3:#1e2230;
  --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.13);
  --accent:#b8f050;--accent-dim:rgba(184,240,80,0.1);--accent-glow:rgba(184,240,80,0.15);
  --accent2:#50c8f0;--gold:#f0c050;--red:#f05060;--red-dim:rgba(240,80,96,0.1);
  --text:#dde0e8;--muted:#55606f;--muted2:#8090a8;
  --sidebar-w:248px;
  --cat-financial:#50c8f0;--cat-market:#b8f050;--cat-risk:#f05060;--cat-macro:#f0c050;--cat-misc:#a070f0;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Sora',sans-serif;font-size:14px;line-height:1.6;display:flex;flex-direction:column;}
.ticker{background:var(--s1);border-bottom:1px solid var(--border);height:34px;overflow:hidden;display:flex;align-items:center;flex-shrink:0;}
.ticker-track{display:flex;animation:tick 45s linear infinite;white-space:nowrap;}
.ticker-track:hover{animation-play-state:paused;}
.t-item{padding:0 24px;font-family:'DM Mono',monospace;font-size:11px;display:flex;align-items:center;gap:8px;}
.t-sym{color:var(--muted2)}.t-price{color:var(--text)}.t-pos{color:var(--accent)}.t-neg{color:var(--red)}
@keyframes tick{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.layout{display:flex;flex:1;overflow:hidden;}
.sidebar{width:var(--sidebar-w);background:var(--s1);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;}
.sidebar-logo{padding:18px 20px 15px;border-bottom:1px solid var(--border);}
.logo-text{font-family:'Playfair Display',serif;font-size:17px;color:var(--accent);}
.logo-sub{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:0.15em;margin-top:2px;}
.sidebar-body{flex:1;overflow-y:auto;padding-bottom:20px;}
.sidebar-body::-webkit-scrollbar{width:3px;}
.sidebar-body::-webkit-scrollbar-thumb{background:var(--border2);}
.nav-section{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:0.15em;text-transform:uppercase;padding:14px 20px 5px;}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 20px;cursor:pointer;color:var(--muted2);font-size:13px;transition:all 0.15s;border-left:2px solid transparent;}
.nav-item:hover{color:var(--text);background:var(--s2);}
.nav-item.active{color:var(--accent);background:var(--accent-dim);border-left-color:var(--accent);}
.nav-icon{font-size:12px;width:16px;text-align:center;flex-shrink:0;}
.stock-nav{display:flex;align-items:center;gap:8px;padding:7px 18px 7px 26px;cursor:pointer;color:var(--muted2);font-size:12px;transition:all 0.15s;border-left:2px solid transparent;}
.stock-nav:hover{color:var(--text);background:var(--s2);}
.stock-nav.active{color:var(--accent);background:var(--accent-dim);border-left-color:var(--accent);}
.stock-nav-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.stock-nav-price{font-family:'DM Mono',monospace;font-size:10px;color:var(--accent);flex-shrink:0;}
.add-btn{display:flex;align-items:center;gap:8px;padding:8px 18px 8px 26px;cursor:pointer;color:var(--muted);font-size:12px;transition:color 0.15s;}
.add-btn:hover{color:var(--accent);}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.content{flex:1;overflow-y:auto;padding:30px 36px 60px;}
.content::-webkit-scrollbar{width:4px;}
.content::-webkit-scrollbar-thumb{background:var(--border2);}
.page{display:none;}
.page.active{display:block;animation:fadeUp 0.2s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.page-header{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:26px;}
.ph-left small{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:0.12em;text-transform:uppercase;display:block;margin-bottom:4px;}
.ph-title{font-family:'Playfair Display',serif;font-size:26px;font-weight:400;}
.ph-right{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);text-align:right;line-height:1.8;}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:22px;}
.stat{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:16px 18px;}
.stat-lbl{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:7px;}
.stat-val{font-size:20px;font-weight:500;letter-spacing:-0.02em;}
.stat-sub{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted2);margin-top:4px;}
.pos{color:var(--accent)}.neg{color:var(--red)}
.card{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:16px;}
.card-title{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:14px;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.htable{width:100%;border-collapse:collapse;}
.htable th{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;padding:0 0 9px;text-align:left;border-bottom:1px solid var(--border);}
.htable th:not(:first-child){text-align:right;}
.htable td{padding:9px 0;border-bottom:1px solid var(--border);font-size:12px;cursor:pointer;}
.htable td:not(:first-child){text-align:right;font-family:'DM Mono',monospace;font-size:11px;}
.htable tr:last-child td{border-bottom:none;}
.htable tr:hover td{color:var(--accent);}
.sn{font-weight:500;font-size:13px;}.st{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-top:1px;}
.chart-area{height:90px;display:flex;align-items:flex-end;gap:2px;margin-top:8px;}
.bar{border-radius:2px 2px 0 0;flex:1;background:var(--s3);transition:background 0.2s;}
.bar:hover,.bar.hi{background:rgba(184,240,80,0.4);}
.btn{background:var(--accent);color:#0b0d11;border:none;padding:8px 18px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Sora',sans-serif;transition:opacity 0.15s;display:inline-flex;align-items:center;gap:7px;}
.btn:hover{opacity:0.85;}
.btn-ghost{background:transparent;color:var(--muted2);border:1px solid var(--border);padding:8px 14px;border-radius:7px;font-size:12px;cursor:pointer;font-family:'Sora',sans-serif;transition:all 0.15s;}
.btn-ghost:hover{border-color:var(--border2);color:var(--text);}
.btn-sm{padding:5px 12px;font-size:11px;}
.gap-8{display:flex;gap:8px;}
/* STOCK PAGE */
.stock-hero{background:linear-gradient(135deg,var(--s1) 0%,var(--s2) 100%);border:1px solid var(--border);border-radius:12px;padding:24px 28px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:flex-start;position:relative;overflow:hidden;}
.stock-hero::before{content:'';position:absolute;top:-40px;right:-40px;width:180px;height:180px;background:radial-gradient(circle,var(--accent-glow) 0%,transparent 70%);pointer-events:none;}
.sh-flag{font-size:26px;margin-bottom:6px;display:block;}
.sh-name{font-family:'Playfair Display',serif;font-size:27px;font-weight:400;line-height:1.1;}
.sh-meta{display:flex;gap:14px;margin-top:6px;flex-wrap:wrap;}
.sh-meta-item{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted2);}
.sh-right{text-align:right;}
.sh-price{font-family:'DM Mono',monospace;font-size:28px;font-weight:500;letter-spacing:-0.03em;}
.stock-tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:20px;margin-top:10px;align-items:center;}
.stag{font-family:'DM Mono',monospace;font-size:10px;padding:3px 10px;border-radius:4px;background:var(--accent-dim);border:1px solid rgba(184,240,80,0.2);color:var(--accent);display:flex;align-items:center;gap:5px;}
.stag-x{cursor:pointer;opacity:0.5;transition:opacity 0.1s;font-size:12px;}.stag-x:hover{opacity:1;}
.stag-add{background:transparent;border:1px dashed var(--border2);color:var(--muted);cursor:pointer;}
.stag-add:hover{border-color:rgba(184,240,80,0.3);color:var(--accent);}
.tag-input-inline{background:transparent;border:none;outline:none;font-family:'DM Mono',monospace;font-size:10px;color:var(--text);width:80px;}
.stock-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:22px;overflow-x:auto;}
.stock-tabs::-webkit-scrollbar{height:2px;}
.stab{padding:10px 18px;font-size:12px;color:var(--muted2);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.15s;white-space:nowrap;flex-shrink:0;}
.stab:hover{color:var(--text);}
.stab.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab-content{display:none;}.tab-content.active{display:block;animation:fadeUp 0.15s ease;}
/* THESIS */
.thesis-box{background:var(--s1);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:20px;}
.thesis-header{padding:12px 18px;background:var(--s2);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.thesis-label{font-family:'DM Mono',monospace;font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:0.15em;}
.thesis-textarea{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;line-height:1.75;resize:none;min-height:90px;padding:16px 18px;}
.thesis-textarea::placeholder{color:var(--muted);}
.thesis-footer{padding:10px 18px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--s2);}
.save-status{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);}
.save-status.saved{color:var(--accent);}
/* NOTES */
.notes-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px;}
.notes-title{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted2);text-transform:uppercase;letter-spacing:0.12em;}
.cat-filters{display:flex;gap:5px;flex-wrap:wrap;}
.cat-filter{font-family:'DM Mono',monospace;font-size:9px;padding:3px 10px;border-radius:20px;border:1px solid var(--border);color:var(--muted2);cursor:pointer;transition:all 0.15s;}
.cat-filter:hover{border-color:var(--border2);color:var(--text);}
.cat-filter.active{border-color:var(--border2);color:var(--text);}
.cat-filter[data-cat="financial"].active{border-color:var(--cat-financial);color:var(--cat-financial);}
.cat-filter[data-cat="market"].active{border-color:var(--cat-market);color:var(--cat-market);}
.cat-filter[data-cat="risk"].active{border-color:var(--cat-risk);color:var(--cat-risk);}
.cat-filter[data-cat="macro"].active{border-color:var(--cat-macro);color:var(--cat-macro);}
.cat-filter[data-cat="misc"].active{border-color:var(--cat-misc);color:var(--cat-misc);}
.note-card{background:var(--s1);border:1px solid var(--border);border-radius:10px;margin-bottom:10px;overflow:hidden;transition:border-color 0.2s;}
.note-card:hover{border-color:var(--border2);}
.note-card-header{padding:12px 16px;display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none;}
.note-cat-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.note-cat-dot[data-cat="financial"]{background:var(--cat-financial);}
.note-cat-dot[data-cat="market"]{background:var(--cat-market);}
.note-cat-dot[data-cat="risk"]{background:var(--cat-risk);}
.note-cat-dot[data-cat="macro"]{background:var(--cat-macro);}
.note-cat-dot[data-cat="misc"]{background:var(--cat-misc);}
.note-card-title{font-size:13px;font-weight:500;flex:1;}
.note-card-meta{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);display:flex;gap:10px;align-items:center;}
.note-card-body{padding:0 16px 14px;font-size:12px;color:var(--muted2);line-height:1.7;display:none;}
.note-card-body.open{display:block;}
.note-card-actions{display:flex;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);}
.note-textarea{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;line-height:1.7;resize:vertical;min-height:80px;outline:none;}
.note-textarea:focus{border-color:rgba(184,240,80,0.3);}
.add-note-form{background:var(--s2);border:1px dashed var(--border2);border-radius:10px;padding:18px;margin-bottom:16px;display:none;}
.add-note-form.open{display:block;animation:fadeUp 0.15s ease;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.form-input{background:var(--s1);border:1px solid var(--border);border-radius:6px;padding:9px 12px;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;outline:none;width:100%;transition:border-color 0.15s;}
.form-input:focus{border-color:rgba(184,240,80,0.35);}
.form-select{background:var(--s1);border:1px solid var(--border);border-radius:6px;padding:9px 12px;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;outline:none;width:100%;cursor:pointer;}
.form-select option{background:var(--s1);}
.form-textarea{width:100%;background:var(--s1);border:1px solid var(--border);border-radius:6px;padding:10px 12px;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;line-height:1.7;resize:vertical;min-height:80px;outline:none;transition:border-color 0.15s;margin-bottom:10px;}
.form-textarea:focus{border-color:rgba(184,240,80,0.35);}
/* BULL BEAR */
.bull-bear-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.bb-card{background:var(--s1);border:1px solid var(--border);border-radius:10px;overflow:hidden;}
.bb-header{padding:12px 16px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);}
.bb-bull .bb-header{background:rgba(184,240,80,0.06);}
.bb-bear .bb-header{background:rgba(240,80,96,0.06);}
.bb-icon{font-size:16px;}
.bb-label{font-family:'DM Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:0.12em;}
.bb-bull .bb-label{color:var(--accent);}.bb-bear .bb-label{color:var(--red);}
.bb-body{padding:14px 16px;}
.bb-textarea{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;line-height:1.75;resize:none;min-height:140px;}
.bb-textarea::placeholder{color:var(--muted);}
/* NYCKELTAL */
.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;}
.kpi-cell{background:var(--s1);border:1px solid var(--border);border-radius:8px;padding:14px;}
.kpi-lbl{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:6px;}
.kpi-input{background:transparent;border:none;color:var(--text);font-size:15px;font-weight:500;font-family:'Sora',sans-serif;width:100%;outline:none;}
.kpi-input::placeholder{color:var(--muted);font-size:13px;}
/* NEWS TAB */
.news-tab-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:8px;}
.news-tab-title{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted2);text-transform:uppercase;letter-spacing:0.12em;}
.news-empty{text-align:center;padding:50px 20px;color:var(--muted);}
.news-empty-icon{font-size:28px;margin-bottom:10px;}
.news-empty-text{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.08em;}
.news-empty-sub{font-size:12px;color:var(--muted);margin-top:6px;}
.news-card{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:18px;margin-bottom:10px;transition:all 0.2s;}
.news-card:hover{border-color:rgba(184,240,80,0.25);transform:translateY(-1px);}
.nc-top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:8px;}
.nc-title{font-size:13px;font-weight:500;line-height:1.4;flex:1;}
.nc-badge{font-family:'DM Mono',monospace;font-size:9px;padding:3px 9px;border-radius:20px;white-space:nowrap;flex-shrink:0;}
.nb-h{background:var(--red-dim);color:var(--red);border:1px solid rgba(240,80,96,0.3);}
.nb-m{background:rgba(240,192,80,0.1);color:var(--gold);border:1px solid rgba(240,192,80,0.3);}
.nb-l{background:var(--accent-dim);color:var(--accent);border:1px solid rgba(184,240,80,0.2);}
.nc-body{font-size:12px;color:var(--muted2);line-height:1.65;margin-bottom:10px;}
.nc-footer{display:flex;justify-content:space-between;align-items:center;}
.nc-tags{display:flex;gap:5px;flex-wrap:wrap;}
.nc-tag{font-family:'DM Mono',monospace;font-size:9px;background:var(--s2);border:1px solid var(--border);padding:2px 8px;border-radius:3px;color:var(--muted2);}
.nc-meta{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);white-space:nowrap;margin-left:10px;}
.nc-link{font-family:'DM Mono',monospace;font-size:10px;color:var(--accent2);text-decoration:none;display:inline-flex;align-items:center;gap:4px;margin-top:8px;}
.nc-link:hover{text-decoration:underline;}
.nc-delete{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);cursor:pointer;margin-left:10px;transition:color 0.15s;}
.nc-delete:hover{color:var(--red);}
.add-news-form{background:var(--s2);border:1px dashed var(--border2);border-radius:10px;padding:18px;margin-bottom:16px;display:none;}
.add-news-form.open{display:block;animation:fadeUp 0.15s ease;}
.sources-textarea{width:100%;background:var(--s1);border:1px solid var(--border);border-radius:8px;padding:14px;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;line-height:1.75;resize:vertical;min-height:160px;outline:none;}
.sources-textarea:focus{border-color:rgba(184,240,80,0.3);}
/* PORTFOLIO GRID */
.pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
.pgrid-card{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:16px;cursor:pointer;transition:all 0.2s;}
.pgrid-card:hover{border-color:rgba(184,240,80,0.3);transform:translateY(-2px);}
.pgc-top{display:flex;justify-content:space-between;margin-bottom:6px;}
.pgc-name{font-weight:500;font-size:13px;}
.pgc-ticker{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted2);margin-top:1px;}
.pgc-price{font-family:'DM Mono',monospace;font-size:13px;color:var(--accent);}
.pgc-thesis{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
.pgc-stats{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
.pgc-stat{font-family:'DM Mono',monospace;font-size:9px;background:var(--s2);padding:2px 7px;border-radius:3px;color:var(--muted2);}
.pgc-add{display:flex;align-items:center;justify-content:center;border-style:dashed;color:var(--muted);font-size:13px;min-height:100px;}
.pgc-add:hover{color:var(--accent);border-color:rgba(184,240,80,0.3);}
/* ONEPAGER */
.onepager-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px;}
.onepager-badge{font-family:'DM Mono',monospace;font-size:10px;background:var(--s2);border:1px solid var(--border);padding:6px 14px;border-radius:20px;color:var(--muted2);}
/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity 0.2s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--s1);border:1px solid var(--border2);border-radius:14px;padding:26px;width:400px;transform:translateY(12px);transition:transform 0.2s;}
.modal-overlay.open .modal{transform:translateY(0);}
.modal-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:400;margin-bottom:18px;}
.modal label{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;display:block;margin-bottom:5px;margin-top:12px;}
.modal input,.modal select{width:100%;background:var(--s2);border:1px solid var(--border2);border-radius:7px;padding:9px 12px;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;outline:none;transition:border-color 0.15s;}
.modal input:focus,.modal select:focus{border-color:rgba(184,240,80,0.4);}
.modal select option{background:var(--s2);}
.modal-btns{display:flex;gap:10px;margin-top:20px;}
.modal-btns .btn,.modal-btns .btn-ghost{flex:1;justify-content:center;}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="ticker"><div class="ticker-track" id="tickerTrack"></div></div>

<div class="layout">
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-text">Portf√∂ljvy</div>
    <div class="logo-sub">Dina investeringar</div>
  </div>
  <div class="sidebar-body">
    <div class="nav-section">√ñversikt</div>
    <div class="nav-item active" onclick="navPage('dashboard',this)"><span class="nav-icon">‚óà</span>Dashboard</div>
    <div class="nav-item" onclick="navPage('onepager',this)"><span class="nav-icon">‚óé</span>Nyheter ¬∑ Onepager</div>
    <div class="nav-section">Portf√∂lj</div>
    <div class="nav-item" onclick="navPage('portfolio',this)"><span class="nav-icon">‚ñ¶</span>Alla bolag</div>
    <div id="stockNav"></div>
    <div class="add-btn" onclick="openModal()"><span style="font-size:15px">+</span> L√§gg till bolag</div>
  </div>
</aside>

<div class="main">
<div class="content">

<div class="page active" id="page-dashboard">
  <div class="page-header">
    <div class="ph-left"><small>V√§lkommen tillbaka</small><div class="ph-title">Dashboard</div></div>
    <div class="ph-right" id="dashDate"></div>
  </div>
  <div class="stats-row">
    <div class="stat"><div class="stat-lbl">Antal innehav</div><div class="stat-val" id="s-count">0</div><div class="stat-sub" id="s-break">‚Äî SE ¬∑ ‚Äî US</div></div>
    <div class="stat"><div class="stat-lbl">Med grundtes</div><div class="stat-val" id="s-thesis">0</div><div class="stat-sub">Bolag med analys</div></div>
    <div class="stat"><div class="stat-lbl">Anteckningar</div><div class="stat-val" id="s-notes">0</div><div class="stat-sub">Totalt sparade</div></div>
    <div class="stat"><div class="stat-lbl">Nyheter sparade</div><div class="stat-val" id="s-news">0</div><div class="stat-sub">Totalt</div></div>
  </div>
  <div class="grid2">
    <div class="card">
      <div class="card-title">Innehav ¬∑ Snabbvy</div>
      <table class="htable"><thead><tr><th>Bolag</th><th>Ticker</th><th>B√∂rs</th><th>Kurs</th></tr></thead>
      <tbody id="dashTableBody"></tbody></table>
    </div>
    <div class="card">
      <div class="card-title">Portf√∂lj ¬∑ Simulerad trend</div>
      <div class="chart-area" id="chartBars"></div>
    </div>
  </div>
</div>

<div class="page" id="page-onepager">
  <div class="page-header">
    <div class="ph-left"><small>Daglig AI-sammanfattning</small><div class="ph-title">Nyheter ¬∑ Onepager</div></div>
    <div class="ph-right" id="onepagerDate"></div>
  </div>
  <div class="onepager-controls">
    <div class="onepager-badge" id="onepagerBadge">Generera f√∂r att h√§mta nyheter anpassade till din portf√∂lj</div>
    <div class="gap-8">
      <button class="btn-ghost">Exportera PDF</button>
      <button class="btn" onclick="generateOnepager()">‚ü≥ Generera nyheter</button>
    </div>
  </div>
  <div id="onepagerContent">
    <div class="news-empty"><div class="news-empty-icon">‚óé</div><div class="news-empty-text">Inga nyheter genererade</div><div class="news-empty-sub">L√§gg till bolag och tryck p√• "Generera nyheter"</div></div>
  </div>
</div>

<div class="page" id="page-portfolio">
  <div class="page-header">
    <div class="ph-left"><small>Portf√∂lj</small><div class="ph-title">Alla bolag</div></div>
    <button class="btn" onclick="openModal()">+ L√§gg till bolag</button>
  </div>
  <div class="pgrid" id="portfolioGrid"></div>
</div>

<div class="page" id="page-stock">
  <div id="stockDetail"></div>
</div>

</div>
</div>
</div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-title">L√§gg till bolag</div>
    <label>Bolagsnamn *</label><input id="m-name" placeholder="t.ex. Ericsson">
    <label>Ticker *</label><input id="m-ticker" placeholder="t.ex. ERIC B">
    <label>B√∂rs</label>
    <select id="m-exchange">
      <option>Stockholmsb√∂rsen üá∏üá™</option><option>NASDAQ üá∫üá∏</option><option>NYSE üá∫üá∏</option><option>Annan</option>
    </select>
    <label>Aktuell kurs</label><input id="m-price" placeholder="t.ex. 80.42">
    <div class="modal-btns">
      <button class="btn-ghost" onclick="closeModal()">Avbryt</button>
      <button class="btn" onclick="addStock()">L√§gg till</button>
    </div>
  </div>
</div>

<script>
let stocks=[], activeId=null, activeTab='anteckningar', noteFilter='all';
const CAT_LABELS={financial:'Finansiellt',market:'Marknadsinsikt',risk:'Risk',macro:'Makro',misc:'√ñvrigt'};
const CAT_COLORS={financial:'var(--cat-financial)',market:'var(--cat-market)',risk:'var(--cat-risk)',macro:'var(--cat-macro)',misc:'var(--cat-misc)'};
const TD=[{sym:'ERIC B',p:'80.42',c:'+1.2%',pos:true},{sym:'INVE A',p:'212.60',c:'-0.4%',pos:false},{sym:'SEB A',p:'143.85',c:'+0.8%',pos:true},{sym:'AAPL',p:'$228.40',c:'+0.3%',pos:true},{sym:'NVDA',p:'$892.10',c:'+2.1%',pos:true},{sym:'MSFT',p:'$415.30',c:'-0.2%',pos:false},{sym:'OMXS30',p:'2 340',c:'+0.5%',pos:true},{sym:'USD/SEK',p:'10.42',c:'+0.1%',pos:true}];

async function load(){try{const r=await window.storage.get('pv3-stocks');if(r)stocks=JSON.parse(r.value);}catch(e){stocks=[];}boot();}
async function save(){try{await window.storage.set('pv3-stocks',JSON.stringify(stocks));}catch(e){}}

function buildTicker(){const t=document.getElementById('tickerTrack');t.innerHTML=[...TD,...TD].map(d=>`<div class="t-item"><span class="t-sym">${d.sym}</span><span class="t-price">${d.p}</span><span class="${d.pos?'t-pos':'t-neg'}">${d.c}</span></div><span style="color:var(--border2);padding:0 4px">¬∑</span>`).join('');}

function navPage(id,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  document.querySelectorAll('.nav-item,.stock-nav').forEach(n=>n.classList.remove('active'));
  if(el)el.classList.add('active');
  if(id==='dashboard')renderDash();
  if(id==='portfolio')renderPortfolioGrid();
  if(id==='onepager'){document.getElementById('onepagerDate').innerHTML=new Date().toLocaleDateString('sv-SE',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).toUpperCase();}
}
function navStock(id,el){
  activeId=id;activeTab='anteckningar';noteFilter='all';
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-stock').classList.add('active');
  document.querySelectorAll('.nav-item,.stock-nav').forEach(n=>n.classList.remove('active'));
  if(el)el.classList.add('active');
  else{document.querySelectorAll('.stock-nav').forEach(n=>{if(n.onclick&&n.getAttribute('onclick')&&n.getAttribute('onclick').includes(id))n.classList.add('active');});}
  renderStockPage();
}
function renderSidebarStocks(){
  document.getElementById('stockNav').innerHTML=stocks.map(s=>`<div class="stock-nav${activeId===s.id?' active':''}" onclick="navStock('${s.id}',this)"><span style="font-size:11px">${s.exchange.includes('üá∏üá™')?'üá∏üá™':'üá∫üá∏'}</span><span class="stock-nav-name">${s.name}</span>${s.price?`<span class="stock-nav-price">${s.price}</span>`:''}</div>`).join('');
}
function renderDash(){
  const now=new Date();
  document.getElementById('dashDate').innerHTML=now.toLocaleDateString('sv-SE',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).toUpperCase();
  const se=stocks.filter(s=>s.exchange.includes('üá∏üá™')).length,us=stocks.length-se;
  document.getElementById('s-count').textContent=stocks.length;
  document.getElementById('s-break').textContent=`${se} SE ¬∑ ${us} US`;
  document.getElementById('s-thesis').textContent=stocks.filter(s=>s.thesis&&s.thesis.trim().length>5).length;
  document.getElementById('s-notes').textContent=stocks.reduce((a,s)=>a+(s.notes||[]).length,0);
  document.getElementById('s-news').textContent=stocks.reduce((a,s)=>a+(s.news||[]).length,0);
  const tbody=document.getElementById('dashTableBody');
  tbody.innerHTML=stocks.length?stocks.map(s=>`<tr onclick="navStock('${s.id}')"><td><div class="sn">${s.exchange.includes('üá∏üá™')?'üá∏üá™':'üá∫üá∏'} ${s.name}</div></td><td><div class="st">${s.ticker}</div></td><td style="font-size:10px;color:var(--muted2)">${s.exchange.replace(/üá∏üá™|üá∫üá∏/g,'').trim()}</td><td>${s.price||'‚Äî'}</td></tr>`).join(''):`<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--muted)">Inga bolag √§nnu ‚Äî tryck + i menyn</td></tr>`;
  const chart=document.getElementById('chartBars'),vals=[55,60,57,65,70,68,75,72,80,77,85,82,88,84,92,88,95,91,98,94,100,97,104,101],mn=Math.min(...vals),mx=Math.max(...vals);
  chart.innerHTML=vals.map((v,i)=>`<div class="bar${i===vals.length-1?' hi':''}" style="height:${((v-mn)/(mx-mn)*68+10).toFixed(1)}px"></div>`).join('');
}
function renderPortfolioGrid(){
  document.getElementById('portfolioGrid').innerHTML=stocks.map(s=>`<div class="pgrid-card" onclick="navStock('${s.id}')"><div class="pgc-top"><div><div class="pgc-name">${s.exchange.includes('üá∏üá™')?'üá∏üá™':'üá∫üá∏'} ${s.name}</div><div class="pgc-ticker">${s.ticker}</div></div><div class="pgc-price">${s.price||'‚Äî'}</div></div><div class="pgc-thesis">${s.thesis||'Ingen grundtes √§nnu...'}</div><div class="pgc-stats"><span class="pgc-stat">${(s.notes||[]).length} noter</span><span class="pgc-stat">${(s.news||[]).length} nyheter</span>${(s.tags||[]).slice(0,2).map(t=>`<span class="pgc-stat">${t}</span>`).join('')}</div></div>`).join('')+`<div class="pgrid-card pgc-add" onclick="openModal()">+ L√§gg till bolag</div>`;
}

function renderStockPage(){
  const s=stocks.find(x=>x.id===activeId);if(!s)return;
  const flag=s.exchange.includes('üá∏üá™')?'üá∏üá™':'üá∫üá∏';
  document.getElementById('stockDetail').innerHTML=`
<div class="stock-hero">
  <div>
    <span class="sh-flag">${flag}</span>
    <div class="sh-name">${s.name}</div>
    <div class="sh-meta"><span class="sh-meta-item">${s.ticker}</span><span class="sh-meta-item">¬∑</span><span class="sh-meta-item">${s.exchange}</span>${s.sector?`<span class="sh-meta-item">¬∑</span><span class="sh-meta-item">${s.sector}</span>`:''}</div>
  </div>
  <div class="sh-right">
    <div class="sh-price">${s.price||'‚Äî'}</div>
    <div style="margin-top:8px"><button class="btn-ghost btn-sm" onclick="promptEditPrice()">Uppdatera kurs</button></div>
  </div>
</div>
<div class="stock-tags" id="stockTags">${renderTags(s)}</div>
<div class="stock-tabs">
  <div class="stab${activeTab==='anteckningar'?' active':''}" onclick="switchTab('anteckningar',this)">üìù Anteckningar</div>
  <div class="stab${activeTab==='nyheter'?' active':''}" onclick="switchTab('nyheter',this)">üì∞ Nyheter</div>
  <div class="stab${activeTab==='bullbear'?' active':''}" onclick="switchTab('bullbear',this)">‚Üë‚Üì Bull / Bear</div>
  <div class="stab${activeTab==='nyckeltal'?' active':''}" onclick="switchTab('nyckeltal',this)">‚óà Nyckeltal</div>
  <div class="stab${activeTab==='k√§llor'?' active':''}" onclick="switchTab('k√§llor',this)">‚äû K√§llor</div>
</div>

<div class="tab-content${activeTab==='anteckningar'?' active':''}" id="tab-anteckningar">
  <div class="thesis-box">
    <div class="thesis-header"><span class="thesis-label">‚¨° Grundtes ‚Äî Varf√∂r √§ger jag detta bolag?</span></div>
    <textarea class="thesis-textarea" id="thesis-input" placeholder="Skriv din grundtes h√§r. Varf√∂r k√∂pte du bolaget? Vad √§r din √∂vertygelse? Vad kr√§vs f√∂r att tesen ska h√•lla?">${s.thesis||''}</textarea>
    <div class="thesis-footer"><span class="save-status" id="thesis-saved">Sparas n√§r du trycker "Spara"</span><button class="btn btn-sm" onclick="saveThesis()">Spara grundtes</button></div>
  </div>
  <div class="notes-toolbar">
    <span class="notes-title">L√∂pande anteckningar</span>
    <div class="cat-filters">
      <div class="cat-filter active" data-cat="all" onclick="filterNotes('all',this)">Alla</div>
      <div class="cat-filter" data-cat="financial" onclick="filterNotes('financial',this)">üíπ Finansiellt</div>
      <div class="cat-filter" data-cat="market" onclick="filterNotes('market',this)">üåê Marknad</div>
      <div class="cat-filter" data-cat="risk" onclick="filterNotes('risk',this)">‚ö†Ô∏è Risk</div>
      <div class="cat-filter" data-cat="macro" onclick="filterNotes('macro',this)">üåç Makro</div>
    </div>
  </div>
  <div class="add-note-form" id="addNoteForm">
    <div class="form-row">
      <input class="form-input" id="note-title" placeholder="Titel...">
      <select class="form-select" id="note-cat">
        <option value="financial">üíπ Finansiellt m√•l/resultat</option>
        <option value="market">üåê Marknadsinsikt</option>
        <option value="risk">‚ö†Ô∏è Risk</option>
        <option value="macro">üåç Makro / Ledande indikator</option>
        <option value="misc">üìå √ñvrigt</option>
      </select>
    </div>
    <textarea class="form-textarea" id="note-body" placeholder="Din anteckning..."></textarea>
    <div class="gap-8"><button class="btn btn-sm" onclick="saveNewNote()">Spara anteckning</button><button class="btn-ghost btn-sm" onclick="toggleAddNote()">Avbryt</button></div>
  </div>
  <div style="margin-bottom:14px"><button class="btn btn-sm" onclick="toggleAddNote()">+ Ny anteckning</button></div>
  <div id="notesList">${renderNotesList(s)}</div>
</div>

<div class="tab-content${activeTab==='nyheter'?' active':''}" id="tab-nyheter">
  <div class="news-tab-header">
    <span class="news-tab-title">Nyheter & insikter ‚Äî ${s.name}</span>
    <div class="gap-8">
      <button class="btn-ghost btn-sm" onclick="toggleAddNews()">+ L√§gg till</button>
      <button class="btn btn-sm" onclick="alert('Koppla in Claude API f√∂r automatiska nyheter!')">‚ü≥ H√§mta AI-nyheter</button>
    </div>
  </div>
  <div class="add-news-form" id="addNewsForm">
    <div class="form-row">
      <input class="form-input" id="news-title" placeholder="Rubrik...">
      <select class="form-select" id="news-impact">
        <option value="h">üî¥ H√∂g p√•verkan</option>
        <option value="m">üü° Medel p√•verkan</option>
        <option value="l">üü¢ Positiv signal</option>
      </select>
    </div>
    <textarea class="form-textarea" id="news-body" placeholder="Din sammanfattning eller analys av nyheten..."></textarea>
    <div class="form-row" style="margin-bottom:10px">
      <input class="form-input" id="news-url" placeholder="L√§nk till k√§lla (valfritt)">
      <input class="form-input" id="news-tags-input" placeholder="Taggar, kommaseparerade">
    </div>
    <div class="gap-8"><button class="btn btn-sm" onclick="saveNews()">Spara nyhet</button><button class="btn-ghost btn-sm" onclick="toggleAddNews()">Avbryt</button></div>
  </div>
  <div id="newsList">${renderNewsList(s)}</div>
</div>

<div class="tab-content${activeTab==='bullbear'?' active':''}" id="tab-bullbear">
  <div class="bull-bear-grid">
    <div class="bb-card bb-bull">
      <div class="bb-header"><span class="bb-icon">‚Üë</span><span class="bb-label">Bull-case</span></div>
      <div class="bb-body"><textarea class="bb-textarea" id="bull-input" placeholder="Katalysatorer? Varf√∂r stiger kursen? Vad √§r max-uppsidan?">${s.bull||''}</textarea><button class="btn btn-sm" onclick="saveBullBear('bull')">Spara</button></div>
    </div>
    <div class="bb-card bb-bear">
      <div class="bb-header"><span class="bb-icon">‚Üì</span><span class="bb-label">Bear-case</span></div>
      <div class="bb-body"><textarea class="bb-textarea" id="bear-input" placeholder="Risker? Vad kan g√• fel? Vad √§r max-nedsidan?">${s.bear||''}</textarea><button class="btn btn-sm" onclick="saveBullBear('bear')">Spara</button></div>
    </div>
  </div>
</div>

<div class="tab-content${activeTab==='nyckeltal'?' active':''}" id="tab-nyckeltal">
  <div class="kpi-grid">
    ${[['Aktuell kurs','price'],['P/E-tal','pe'],['Direktavkastning','div_yield'],['B√∂rsv√§rde','marketcap'],['Sektor','sector'],['EV/EBITDA','ev_ebitda'],['Oms√§ttningstillv√§xt','rev_growth'],['R√∂relsemarginal','op_margin'],['Nettoskuld/EBITDA','net_debt']].map(([lbl,key])=>`<div class="kpi-cell"><div class="kpi-lbl">${lbl}</div><input class="kpi-input" value="${s[key]||''}" placeholder="‚Äî" onchange="updateKpi('${key}',this.value)"></div>`).join('')}
  </div>
  <button class="btn btn-sm" onclick="saveKpis()">Spara nyckeltal</button>
</div>

<div class="tab-content${activeTab==='k√§llor'?' active':''}" id="tab-k√§llor">
  <div class="card-title" style="margin-bottom:10px">L√§nkar, rapporter & k√§llor</div>
  <textarea class="sources-textarea" id="sources-input" placeholder="Klistra in l√§nkar, rapportnoteringar, analytiker-kommentarer...&#10;&#10;Ex:&#10;https://investors.ericsson.com&#10;Q4 2025 ‚Äî stark ordertillv√§xt i Indien&#10;Morgan Stanley h√∂jer riktkurs till 95 kr">${s.sources||''}</textarea>
  <div style="margin-top:10px"><button class="btn btn-sm" onclick="saveSources()">Spara</button></div>
</div>`;
}

function renderTags(s){return(s.tags||[]).map(t=>`<div class="stag">${t}<span class="stag-x" onclick="removeTag('${t}')">√ó</span></div>`).join('')+`<div class="stag stag-add" onclick="startTagInput()">+ Tagg</div>`;}

function renderNotesList(s){
  const notes=(s.notes||[]).filter(n=>noteFilter==='all'||n.cat===noteFilter);
  if(!notes.length)return`<div style="text-align:center;padding:30px;color:var(--muted);font-size:12px">Inga anteckningar${noteFilter!=='all'?' i denna kategori':' √§nnu'} ‚Äî tryck "+ Ny anteckning"</div>`;
  return notes.map(n=>`<div class="note-card"><div class="note-card-header" onclick="toggleNote(this)"><div class="note-cat-dot" data-cat="${n.cat}"></div><div class="note-card-title">${n.title}</div><div class="note-card-meta"><span style="color:${CAT_COLORS[n.cat]||'var(--muted2)'}">${CAT_LABELS[n.cat]||n.cat}</span><span>${n.date||''}</span><span>‚ñæ</span></div></div><div class="note-card-body" id="nbody-${n.id}"><textarea class="note-textarea" onchange="updateNoteBody('${n.id}',this.value)">${n.body}</textarea><div class="note-card-actions"><button class="btn btn-sm" onclick="saveNoteEdit('${n.id}',this)">Spara</button><button class="btn-ghost btn-sm" onclick="deleteNote('${n.id}')">Ta bort</button></div></div></div>`).join('');
}

function renderNewsList(s){
  const news=s.news||[];
  if(!news.length)return`<div class="news-empty"><div class="news-empty-icon">üì∞</div><div class="news-empty-text">Inga nyheter sparade</div><div class="news-empty-sub">L√§gg till manuellt eller koppla in API</div></div>`;
  return news.map(n=>`<div class="news-card"><div class="nc-top"><div class="nc-title">${n.title}</div><div class="nc-badge ${n.impact==='h'?'nb-h':n.impact==='m'?'nb-m':'nb-l'}">${n.impact==='h'?'H√ñG P√ÖVERKAN':n.impact==='m'?'MEDEL':'POSITIV'}</div></div><div class="nc-body">${n.body}</div><div class="nc-footer"><div class="nc-tags">${(n.tags||[]).map(t=>`<span class="nc-tag">${t}</span>`).join('')}</div><div style="display:flex;align-items:center;gap:8px"><span class="nc-meta">${n.date||''}</span><span class="nc-delete" onclick="deleteNews('${n.id}')">‚úï</span></div></div>${n.url?`<a class="nc-link" href="${n.url}" target="_blank">‚Üó L√§s originalk√§lla</a>`:''}</div>`).join('');
}

function switchTab(tab,el){
  activeTab=tab;
  document.querySelectorAll('.stab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  if(el)el.classList.add('active');
  const tc=document.getElementById('tab-'+tab);if(tc)tc.classList.add('active');
}
function saveThesis(){const s=stocks.find(x=>x.id===activeId);if(!s)return;s.thesis=document.getElementById('thesis-input').value;save();renderSidebarStocks();const el=document.getElementById('thesis-saved');if(el){el.textContent='Sparad ‚úì';el.classList.add('saved');setTimeout(()=>{el.textContent='Sparas n√§r du trycker "Spara"';el.classList.remove('saved');},2000);}}
function toggleAddNote(){const f=document.getElementById('addNoteForm');f.classList.toggle('open');if(f.classList.contains('open'))document.getElementById('note-title').focus();}
function saveNewNote(){
  const s=stocks.find(x=>x.id===activeId);if(!s)return;
  const title=document.getElementById('note-title').value.trim(),body=document.getElementById('note-body').value.trim();
  if(!title&&!body)return;
  if(!s.notes)s.notes=[];
  s.notes.unshift({id:'n'+Date.now(),title:title||'Utan titel',body,cat:document.getElementById('note-cat').value,date:new Date().toLocaleDateString('sv-SE')});
  save();document.getElementById('note-title').value='';document.getElementById('note-body').value='';
  document.getElementById('addNoteForm').classList.remove('open');
  document.getElementById('notesList').innerHTML=renderNotesList(stocks.find(x=>x.id===activeId));
}
function toggleNote(el){const body=el.nextElementSibling;body.classList.toggle('open');el.querySelector('span:last-child').textContent=body.classList.contains('open')?'‚ñ¥':'‚ñæ';}
function filterNotes(cat,el){noteFilter=cat;document.querySelectorAll('.cat-filter').forEach(f=>f.classList.remove('active'));el.classList.add('active');const s=stocks.find(x=>x.id===activeId);if(s)document.getElementById('notesList').innerHTML=renderNotesList(s);}
function updateNoteBody(id,val){const s=stocks.find(x=>x.id===activeId);if(!s)return;const n=(s.notes||[]).find(x=>x.id===id);if(n)n.body=val;}
function saveNoteEdit(id,btn){save();const b=btn||event.target;b.textContent='Sparad ‚úì';setTimeout(()=>{b.textContent='Spara';},1500);}
function deleteNote(id){const s=stocks.find(x=>x.id===activeId);if(!s)return;s.notes=(s.notes||[]).filter(n=>n.id!==id);save();document.getElementById('notesList').innerHTML=renderNotesList(s);}
function toggleAddNews(){const f=document.getElementById('addNewsForm');f.classList.toggle('open');if(f.classList.contains('open'))document.getElementById('news-title').focus();}
function saveNews(){
  const s=stocks.find(x=>x.id===activeId);if(!s)return;
  const title=document.getElementById('news-title').value.trim();if(!title)return;
  if(!s.news)s.news=[];
  const tags=document.getElementById('news-tags-input').value.split(',').map(t=>t.trim()).filter(Boolean);
  s.news.unshift({id:'nw'+Date.now(),title,body:document.getElementById('news-body').value,impact:document.getElementById('news-impact').value,url:document.getElementById('news-url').value,tags,date:new Date().toLocaleDateString('sv-SE')});
  save();['news-title','news-body','news-url','news-tags-input'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('addNewsForm').classList.remove('open');
  document.getElementById('newsList').innerHTML=renderNewsList(stocks.find(x=>x.id===activeId));
}
function deleteNews(id){const s=stocks.find(x=>x.id===activeId);if(!s)return;s.news=(s.news||[]).filter(n=>n.id!==id);save();document.getElementById('newsList').innerHTML=renderNewsList(s);}
function saveBullBear(key){const s=stocks.find(x=>x.id===activeId);if(!s)return;s[key]=document.getElementById(key+'-input').value;save();const btn=event.target;btn.textContent='Sparad ‚úì';setTimeout(()=>{btn.textContent='Spara';},1500);}
function updateKpi(key,val){const s=stocks.find(x=>x.id===activeId);if(s)s[key]=val;}
function saveKpis(){save();renderSidebarStocks();const btn=event.target;btn.textContent='Sparad ‚úì';setTimeout(()=>{btn.textContent='Spara nyckeltal';},1500);}
function saveSources(){const s=stocks.find(x=>x.id===activeId);if(s){s.sources=document.getElementById('sources-input').value;save();const btn=event.target;btn.textContent='Sparad ‚úì';setTimeout(()=>{btn.textContent='Spara';},1500);}}
function promptEditPrice(){const s=stocks.find(x=>x.id===activeId);if(!s)return;const p=prompt(`Ny kurs f√∂r ${s.name}:`,s.price||'');if(p!==null){s.price=p.trim();save();renderSidebarStocks();renderStockPage();}}
function removeTag(tag){const s=stocks.find(x=>x.id===activeId);if(s){s.tags=(s.tags||[]).filter(t=>t!==tag);save();document.getElementById('stockTags').innerHTML=renderTags(s);}}
function startTagInput(){
  const s=stocks.find(x=>x.id===activeId);if(!s)return;
  const container=document.getElementById('stockTags'),addBtn=container.querySelector('.stag-add');
  const inp=document.createElement('input');inp.className='tag-input-inline';inp.placeholder='Ny tagg...';
  addBtn.replaceWith(inp);inp.focus();
  inp.onkeydown=e=>{if(e.key==='Enter'||e.key===','){e.preventDefault();const v=inp.value.trim();if(v){if(!s.tags)s.tags=[];if(!s.tags.includes(v))s.tags.push(v);save();}container.innerHTML=renderTags(s);}if(e.key==='Escape')container.innerHTML=renderTags(s);};
  inp.onblur=()=>setTimeout(()=>{if(document.contains(inp))container.innerHTML=renderTags(s);},200);
}
function generateOnepager(){
  if(!stocks.length){document.getElementById('onepagerContent').innerHTML=`<div class="news-empty"><div class="news-empty-icon">‚óé</div><div class="news-empty-text">L√§gg till bolag f√∂rst</div></div>`;return;}
  document.getElementById('onepagerBadge').textContent='Genererar...';
  document.getElementById('onepagerContent').innerHTML=`<div style="text-align:center;padding:60px;color:var(--muted)"><div style="font-size:24px;display:inline-block;animation:spin 1s linear infinite">‚óå</div><br><br>Analyserar ${stocks.length} bolag...</div>`;
  setTimeout(()=>{
    const now=new Date();
    document.getElementById('onepagerBadge').textContent=`Genererad ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')} ¬∑ ${stocks.length} bolag bevakade`;
    const items=[{title:'Fed-protokoll: splittrad syn p√• r√§ntebanan p√•verkar riskaptiten globalt',body:'Federal Reserve-ledam√∂ter √§r oeniga om takten f√∂r kommande s√§nkningar. Mer restriktiv ton d√§mpar riskaptit och kan p√•verka tillv√§xtaktier negativt.',impact:'h',tags:['Makro','Fed','R√§nta']},{title:'Stark efterfr√•gan p√• AI-infrastruktur ‚Äî analytiker h√∂jer estimat',body:'Hyperscalers √∂kar datacenterinvesteringar. Positivt f√∂r bolag exponerade mot AI-v√§rdekedjan och halvledare.',impact:'l',tags:['AI','Tech','Halvledare']},{title:'Riksbanken √∂ppnar f√∂r r√§ntes√§nkning Q2 ‚Äî gynnar r√§ntek√§nsliga bolag',body:'Vice riksbankschefen signalerar att inflationsdatan m√∂jligg√∂r en s√§nkning under v√•ren. Positivt f√∂r h√∂gt bel√•nade bolag.',impact:'m',tags:['Riksbanken','Sverige']}];
    document.getElementById('onepagerContent').innerHTML=items.map(n=>`<div class="news-card"><div class="nc-top"><div class="nc-title">${n.title}</div><div class="nc-badge ${n.impact==='h'?'nb-h':n.impact==='m'?'nb-m':'nb-l'}">${n.impact==='h'?'H√ñG P√ÖVERKAN':n.impact==='m'?'MEDEL':'POSITIV SIGNAL'}</div></div><div class="nc-body">${n.body}</div><div class="nc-footer"><div class="nc-tags">${n.tags.map(t=>`<span class="nc-tag">${t}</span>`).join('')}${stocks.slice(0,2).map(s=>`<span class="nc-tag">${s.ticker}</span>`).join('')}</div><span class="nc-meta">${now.toLocaleDateString('sv-SE')}</span></div></div>`).join('');
  },1600);
}
function openModal(){document.getElementById('modalOverlay').classList.add('open');setTimeout(()=>document.getElementById('m-name').focus(),200);}
function closeModal(){document.getElementById('modalOverlay').classList.remove('open');}
function addStock(){
  const name=document.getElementById('m-name').value.trim(),ticker=document.getElementById('m-ticker').value.trim().toUpperCase();
  if(!name||!ticker){alert('Namn och ticker kr√§vs');return;}
  const s={id:'s'+Date.now(),name,ticker,exchange:document.getElementById('m-exchange').value,price:document.getElementById('m-price').value.trim(),thesis:'',notes:[],news:[],tags:[],bull:'',bear:'',sources:'',pe:'',div_yield:'',marketcap:'',sector:'',ev_ebitda:'',rev_growth:'',op_margin:'',net_debt:''};
  stocks.push(s);save();closeModal();
  ['m-name','m-ticker','m-price'].forEach(id=>document.getElementById(id).value='');
  renderSidebarStocks();navStock(s.id);
}
document.getElementById('modalOverlay').addEventListener('click',e=>{if(e.target===document.getElementById('modalOverlay'))closeModal();});
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});
function boot(){buildTicker();renderSidebarStocks();renderDash();}
load();
</script>
</body>
</html>
