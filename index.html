<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portf√∂ljvy</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@300;400;500&family=Sora:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  /* ‚îÄ‚îÄ LIGHT CREAM PALETTE ‚îÄ‚îÄ */
  --bg:#f5f0e8;          /* warm cream base */
  --s1:#ede8df;          /* slightly darker cream for cards */
  --s2:#e4ddd2;          /* card surfaces */
  --s3:#d9d1c4;          /* deeper surface */
  --s4:#cec5b6;          /* borders/dividers */

  --border:rgba(42,74,115,0.12);
  --border2:rgba(42,74,115,0.22);

  /* ‚îÄ‚îÄ TWO BLUES ‚îÄ‚îÄ */
  --blue-dark:#1e3a5f;   /* deep navy ‚Äî primary text, headings */
  --blue-mid:#2d6a9f;    /* medium blue ‚Äî accents, active states */
  --blue-light:#4a90c4;  /* lighter blue ‚Äî secondary accents, hover */
  --blue-pale:rgba(45,106,159,0.1);  /* tinted background */
  --blue-pale2:rgba(45,106,159,0.18);

  --accent:var(--blue-mid);
  --adim:var(--blue-pale);
  --aglow:rgba(45,106,159,0.12);

  /* ‚îÄ‚îÄ SEMANTIC ‚îÄ‚îÄ */
  --text:var(--blue-dark);
  --muted:rgba(30,58,95,0.45);
  --muted2:rgba(30,58,95,0.65);
  --red:#c0392b;
  --rdim:rgba(192,57,43,0.08);
  --gold:#b8860b;
  --green:#2a7a4b;

  /* ‚îÄ‚îÄ CAT COLORS ‚îÄ‚îÄ */
  --cf:var(--blue-mid);
  --cm:var(--blue-light);
  --cr:var(--red);
  --cma:var(--gold);
  --co:#7b5ea7;

  --sw:248px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Sora',sans-serif;font-size:14px;line-height:1.6;display:flex;flex-direction:column;}

/* LAYOUT */
.layout{display:flex;flex:1;overflow:hidden;}

/* SIDEBAR */
.sidebar{width:var(--sw);background:linear-gradient(180deg,#1e3a5f 0%,#243f66 35%,#2a4a78 65%,#4a6e96 78%,#8aabcc 88%,#c8d8e8 94%,#e8ded0 100%);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;box-shadow:2px 0 16px rgba(30,58,95,0.2);}
.slogo{padding:22px 20px 18px;border-bottom:1px solid rgba(255,255,255,0.1);background:rgba(0,0,0,0.08);}
.slogo-t{font-family:'Playfair Display',serif;font-size:18px;color:#f5f0e8;letter-spacing:0.01em;}
.slogo-s{font-family:'DM Mono',monospace;font-size:9px;color:rgba(245,240,232,0.45);letter-spacing:0.15em;margin-top:3px;}
.sbody{flex:1;overflow-y:auto;padding-bottom:20px;}
.sbody::-webkit-scrollbar{width:3px;}
.sbody::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);}
.nsec{font-family:'DM Mono',monospace;font-size:9px;color:rgba(245,240,232,0.35);letter-spacing:0.18em;text-transform:uppercase;padding:16px 20px 5px;}
.ni{display:flex;align-items:center;gap:9px;padding:9px 20px;cursor:pointer;color:rgba(245,240,232,0.6);font-size:13px;transition:all 0.15s;border-left:2px solid transparent;}
.ni:hover{color:#f5f0e8;background:rgba(255,255,255,0.07);}
.ni.active{color:#f5f0e8;background:rgba(74,144,196,0.22);border-left-color:rgba(180,210,245,0.8);}
.sni{display:flex;align-items:center;gap:8px;padding:7px 18px 7px 26px;cursor:pointer;color:rgba(245,240,232,0.55);font-size:12px;transition:all 0.15s;border-left:2px solid transparent;}
.sni:hover{color:#f5f0e8;background:rgba(255,255,255,0.07);}
.sni.active{color:#f5f0e8;background:rgba(74,144,196,0.22);border-left-color:rgba(180,210,245,0.8);}
.sni-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.sni-price{font-family:'DM Mono',monospace;font-size:10px;color:rgba(180,210,245,0.85);flex-shrink:0;}
.addbtn{display:flex;align-items:center;gap:8px;padding:9px 18px 9px 26px;cursor:pointer;color:rgba(245,240,232,0.55);font-size:12px;transition:color 0.15s;}
.addbtn:hover{color:#f5f0e8;}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.content{flex:1;overflow-y:auto;padding:32px 38px 60px;}
.content::-webkit-scrollbar{width:4px;}
.content::-webkit-scrollbar-thumb{background:var(--s3);}

/* PAGES */
.page{display:none;}
.page.active{display:block;animation:fu 0.2s ease;}
@keyframes fu{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* PAGE HEADER */
.ph{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:28px;}
.ph-l small{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:0.12em;text-transform:uppercase;display:block;margin-bottom:4px;}
.ph-title{font-family:'Playfair Display',serif;font-size:27px;font-weight:400;color:var(--blue-dark);}
.ph-r{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);text-align:right;line-height:1.8;}

/* STATS */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:22px;}
.stat{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:16px 18px;box-shadow:0 1px 3px rgba(30,58,95,0.06);}
.sl{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:7px;}
.sv{font-size:20px;font-weight:600;letter-spacing:-0.02em;color:var(--blue-dark);}
.ss{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted2);margin-top:4px;}
.pos{color:var(--green)}.neg{color:var(--red)}

/* CARDS */
.card{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:20px;margin-bottom:16px;box-shadow:0 1px 3px rgba(30,58,95,0.06);}
.ct{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:14px;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}

/* TABLE */
.ht{width:100%;border-collapse:collapse;}
.ht th{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.1em;padding:0 0 9px;text-align:left;border-bottom:1px solid var(--border);}
.ht th:not(:first-child){text-align:right;}
.ht td{padding:9px 0;border-bottom:1px solid var(--border);font-size:12px;cursor:pointer;}
.ht td:not(:first-child){text-align:right;font-family:'DM Mono',monospace;font-size:11px;}
.ht tr:last-child td{border-bottom:none;}
.ht tr:hover td{color:var(--blue-mid);}
.sn{font-weight:500;font-size:13px;color:var(--blue-dark);}
.st{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-top:1px;}

/* CHART */
.chart{height:90px;display:flex;align-items:flex-end;gap:2px;margin-top:8px;}
.bar{border-radius:2px 2px 0 0;flex:1;background:var(--s3);transition:background 0.2s;}
.bar:hover,.bar.hi{background:var(--blue-light);opacity:0.7;}

/* BUTTONS */
.btn{background:var(--blue-mid);color:#fff;border:none;padding:8px 18px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Sora',sans-serif;transition:all 0.15s;display:inline-flex;align-items:center;gap:7px;}
.btn:hover{background:var(--blue-dark);}
.bg{background:transparent;color:var(--muted2);border:1px solid var(--border2);padding:8px 14px;border-radius:7px;font-size:12px;cursor:pointer;font-family:'Sora',sans-serif;transition:all 0.15s;}
.bg:hover{border-color:var(--blue-mid);color:var(--blue-mid);}
.bsm{padding:5px 12px;font-size:11px;}
.gap8{display:flex;gap:8px;align-items:center;}

/* ‚ïê‚ïê STOCK HERO ‚ïê‚ïê */
.hero{background:var(--blue-dark);border-radius:12px;padding:22px 26px;margin-bottom:8px;position:relative;overflow:hidden;box-shadow:0 4px 16px rgba(30,58,95,0.2);}
.hero::before{content:'';position:absolute;top:-60px;right:-60px;width:220px;height:220px;background:radial-gradient(circle,rgba(74,144,196,0.2) 0%,transparent 70%);pointer-events:none;}
.hero-top{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;margin-bottom:16px;}
.hero-bottom{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;border-top:1px solid rgba(255,255,255,0.1);padding-top:14px;}
.hflag{font-size:22px;margin-bottom:4px;display:block;}
.hname{font-family:'Playfair Display',serif;font-size:24px;font-weight:400;line-height:1.1;color:#f5f0e8;}
.hmeta{display:flex;gap:12px;margin-top:5px;flex-wrap:wrap;align-items:center;}
.hmi{font-family:'DM Mono',monospace;font-size:10px;color:rgba(245,240,232,0.55);}
.hbd-badge{font-family:'DM Mono',monospace;font-size:9px;padding:2px 7px;border-radius:10px;background:rgba(42,122,75,0.3);border:1px solid rgba(42,122,75,0.5);color:rgba(180,240,200,0.9);}
.hprice{font-family:'DM Mono',monospace;font-size:26px;font-weight:500;letter-spacing:-0.03em;color:#f5f0e8;text-align:right;}
.hprice-label{font-family:'DM Mono',monospace;font-size:9px;color:rgba(245,240,232,0.4);text-align:right;margin-bottom:3px;text-transform:uppercase;letter-spacing:0.1em;}
.hstat{background:rgba(255,255,255,0.06);border-radius:8px;padding:10px 12px;border:1px solid rgba(255,255,255,0.08);}
.hstat-label{font-family:'DM Mono',monospace;font-size:9px;color:rgba(245,240,232,0.4);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:5px;}
.hstat-val{font-family:'DM Mono',monospace;font-size:16px;font-weight:500;color:#f5f0e8;letter-spacing:-0.01em;}
.hstat-val.pos{color:#7dd4a0;}
.hstat-val.neg{color:#f08080;}
.hstat-sub{font-family:'DM Mono',monospace;font-size:9px;color:rgba(245,240,232,0.35);margin-top:3px;}
.hdesc{font-size:11px;color:rgba(245,240,232,0.6);line-height:1.65;max-width:560px;}
.hceo{font-family:'DM Mono',monospace;font-size:10px;color:rgba(245,240,232,0.5);margin-top:5px;display:flex;align-items:center;gap:5px;}
.hceo-name{color:rgba(245,240,232,0.75);}

/* TAGS */
.tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:18px;margin-top:10px;align-items:center;}
.tag{font-family:'DM Mono',monospace;font-size:10px;padding:3px 10px;border-radius:4px;background:var(--blue-pale);border:1px solid var(--border2);color:var(--blue-mid);display:flex;align-items:center;gap:5px;}
.tagx{cursor:pointer;opacity:0.5;transition:opacity 0.1s;font-size:12px;}.tagx:hover{opacity:1;}
.tagadd{background:transparent;border:1px dashed var(--border2);color:var(--muted);cursor:pointer;}
.tagadd:hover{border-color:var(--blue-mid);color:var(--blue-mid);}
.taginput{background:transparent;border:none;outline:none;font-family:'DM Mono',monospace;font-size:10px;color:var(--text);width:80px;}

/* STOCK TABS */
.stabs{display:flex;border-bottom:2px solid var(--border);margin-bottom:0;overflow-x:auto;}
.stabs::-webkit-scrollbar{height:2px;}
.stab{padding:10px 16px;font-size:12px;color:var(--muted2);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all 0.15s;white-space:nowrap;flex-shrink:0;}
.stab:hover{color:var(--blue-mid);}
.stab.active{color:var(--blue-dark);border-bottom-color:var(--blue-mid);font-weight:500;}
.tc{display:none;padding-top:22px;}.tc.active{display:block;animation:fu 0.15s ease;}

/* SPLIT LAYOUT */
.split{display:grid;grid-template-columns:1fr 360px;gap:0;min-height:580px;border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:16px;box-shadow:0 1px 4px rgba(30,58,95,0.08);}
.split-left{border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;background:var(--s1);}
.split-right{background:#fff;display:flex;flex-direction:column;overflow:hidden;}

/* NOTES PANEL */
.np-header{padding:14px 18px;background:var(--s2);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
.np-title{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted2);text-transform:uppercase;letter-spacing:0.12em;}
.np-body{flex:1;overflow-y:auto;padding:16px 18px;}
.np-body::-webkit-scrollbar{width:3px;}
.np-body::-webkit-scrollbar-thumb{background:var(--s3);}

/* THESIS */
.tbox{margin-bottom:18px;}
.tbox-label{font-family:'DM Mono',monospace;font-size:9px;color:var(--blue-mid);text-transform:uppercase;letter-spacing:0.15em;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
.tbox-ta{width:100%;background:#fff;border:1px solid var(--border);border-radius:8px;padding:12px 14px;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;line-height:1.75;resize:none;min-height:100px;outline:none;transition:border-color 0.15s;}
.tbox-ta:focus{border-color:var(--blue-mid);}
.tbox-footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px;}
.saved-hint{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);transition:color 0.2s;}
.saved-hint.ok{color:var(--green);}

/* REVISION LOG */
.revlog{margin-top:12px;}
.revlog-title{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:8px;display:flex;justify-content:space-between;}
.reventry{background:var(--s2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;margin-bottom:6px;font-size:11px;color:var(--muted2);line-height:1.6;}
.reventry-date{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);margin-bottom:4px;}

/* NOTE FILTERS */
.nfilters{display:flex;gap:4px;flex-wrap:wrap;}
.nf{font-family:'DM Mono',monospace;font-size:9px;padding:3px 9px;border-radius:20px;border:1px solid var(--border);color:var(--muted2);cursor:pointer;transition:all 0.15s;}
.nf:hover{border-color:var(--border2);color:var(--blue-mid);}
.nf.active{border-color:var(--blue-mid);color:var(--blue-mid);background:var(--blue-pale);}
.nf[data-c="financial"].active{border-color:var(--cf);color:var(--cf);background:rgba(45,106,159,0.08);}
.nf[data-c="market"].active{border-color:var(--cm);color:var(--cm);background:rgba(74,144,196,0.08);}
.nf[data-c="risk"].active{border-color:var(--cr);color:var(--cr);background:rgba(192,57,43,0.08);}
.nf[data-c="macro"].active{border-color:var(--cma);color:var(--cma);background:rgba(184,134,11,0.08);}

/* NOTE CARDS */
.ncard{background:#fff;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;overflow:hidden;transition:border-color 0.2s;box-shadow:0 1px 2px rgba(30,58,95,0.04);}
.ncard:hover{border-color:var(--blue-mid);}
.ncard-h{padding:10px 14px;display:flex;align-items:center;gap:9px;cursor:pointer;user-select:none;}
.ndot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.ndot[data-c="financial"]{background:var(--cf);}
.ndot[data-c="market"]{background:var(--cm);}
.ndot[data-c="risk"]{background:var(--cr);}
.ndot[data-c="macro"]{background:var(--cma);}
.ndot[data-c="misc"]{background:var(--co);}
.ncard-title{font-size:12px;font-weight:500;flex:1;color:var(--blue-dark);}
.ncard-meta{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);display:flex;gap:8px;}
.ncard-body{padding:0 14px 12px;display:none;}
.ncard-body.open{display:block;}
.ncard-ta{width:100%;background:var(--s1);border:1px solid var(--border);border-radius:6px;padding:8px 10px;color:var(--text);font-family:'Sora',sans-serif;font-size:11px;line-height:1.7;resize:vertical;min-height:60px;outline:none;margin-bottom:8px;}
.ncard-ta:focus{border-color:var(--blue-mid);}
.ncard-actions{display:flex;gap:6px;}

/* ADD FORMS */
.anf{background:var(--s2);border:1px dashed var(--border2);border-radius:8px;padding:14px;margin-bottom:12px;display:none;}
.anf.open{display:block;animation:fu 0.15s ease;}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;}
.fi{background:#fff;border:1px solid var(--border);border-radius:6px;padding:8px 10px;color:var(--text);font-family:'Sora',sans-serif;font-size:11px;outline:none;width:100%;transition:border-color 0.15s;}
.fi:focus{border-color:var(--blue-mid);}
.fsel{background:#fff;border:1px solid var(--border);border-radius:6px;padding:8px 10px;color:var(--text);font-family:'Sora',sans-serif;font-size:11px;outline:none;width:100%;cursor:pointer;}
.fsel option{background:#fff;}
.fta{width:100%;background:#fff;border:1px solid var(--border);border-radius:6px;padding:8px 10px;color:var(--text);font-family:'Sora',sans-serif;font-size:11px;line-height:1.7;resize:vertical;min-height:70px;outline:none;transition:border-color 0.15s;margin-bottom:8px;}
.fta:focus{border-color:var(--blue-mid);}

/* CHAT PANEL */
.chat-header{padding:14px 16px;background:var(--s2);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
.chat-title{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted2);text-transform:uppercase;letter-spacing:0.12em;}
.chat-status{font-family:'DM Mono',monospace;font-size:9px;padding:3px 8px;border-radius:10px;background:var(--rdim);color:var(--red);border:1px solid rgba(192,57,43,0.25);}
.chat-status.connected{background:rgba(42,122,75,0.1);color:var(--green);border-color:rgba(42,122,75,0.3);}
.chat-messages{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px;}
.chat-messages::-webkit-scrollbar{width:3px;}
.chat-messages::-webkit-scrollbar-thumb{background:var(--s3);}
.msg{max-width:88%;font-size:12px;line-height:1.65;}
.msg-ai{align-self:flex-start;}
.msg-user{align-self:flex-end;}
.msg-bubble{padding:10px 13px;border-radius:10px;}
.msg-ai .msg-bubble{background:var(--s1);border:1px solid var(--border);color:var(--text);border-radius:4px 10px 10px 10px;}
.msg-user .msg-bubble{background:var(--blue-dark);color:#f5f0e8;border-radius:10px 4px 10px 10px;}
.msg-name{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);margin-bottom:4px;}
.chat-input-area{padding:12px;border-top:1px solid var(--border);flex-shrink:0;background:var(--s1);}
.chat-input-row{display:flex;gap:8px;align-items:flex-end;}
.chat-ta{flex:1;background:#fff;border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;line-height:1.5;resize:none;min-height:40px;max-height:100px;outline:none;transition:border-color 0.15s;}
.chat-ta:focus{border-color:var(--blue-mid);}
.chat-send{background:var(--blue-mid);color:#fff;border:none;border-radius:8px;width:36px;height:36px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background 0.15s;}
.chat-send:hover{background:var(--blue-dark);}
.chat-hint{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);margin-top:6px;text-align:center;}
.chat-api-notice{padding:20px 16px;text-align:center;}
.can-icon{font-size:24px;margin-bottom:8px;}
.can-title{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted2);letter-spacing:0.08em;margin-bottom:6px;}
.can-body{font-size:11px;color:var(--muted2);line-height:1.6;margin-bottom:12px;}
.api-input{width:100%;background:#fff;border:1px solid var(--border2);border-radius:6px;padding:8px 10px;color:var(--text);font-family:'DM Mono',monospace;font-size:11px;outline:none;margin-bottom:8px;}
.api-input:focus{border-color:var(--blue-mid);}

/* NEWS */
.news-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;}
.news-empty{text-align:center;padding:40px 20px;color:var(--muted);}
.anwf{background:var(--s2);border:1px dashed var(--border2);border-radius:10px;padding:16px;margin-bottom:14px;display:none;}
.anwf.open{display:block;animation:fu 0.15s ease;}
.nwcard{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:10px;transition:all 0.2s;box-shadow:0 1px 2px rgba(30,58,95,0.05);}
.nwcard:hover{border-color:var(--blue-mid);transform:translateY(-1px);}
.nwc-top{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:7px;}
.nwc-title{font-size:13px;font-weight:500;line-height:1.4;flex:1;color:var(--blue-dark);}
.nbadge{font-family:'DM Mono',monospace;font-size:9px;padding:3px 9px;border-radius:20px;white-space:nowrap;flex-shrink:0;}
.nbh{background:var(--rdim);color:var(--red);border:1px solid rgba(192,57,43,0.3);}
.nbm{background:rgba(184,134,11,0.1);color:var(--gold);border:1px solid rgba(184,134,11,0.3);}
.nbl{background:rgba(42,122,75,0.08);color:var(--green);border:1px solid rgba(42,122,75,0.3);}
.nwc-body{font-size:12px;color:var(--muted2);line-height:1.65;margin-bottom:8px;}
.nwc-foot{display:flex;justify-content:space-between;align-items:center;}
.nwc-tags{display:flex;gap:4px;flex-wrap:wrap;}
.nwtag{font-family:'DM Mono',monospace;font-size:9px;background:var(--s2);border:1px solid var(--border);padding:2px 7px;border-radius:3px;color:var(--muted2);}
.nwc-meta{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);}
.nwlink{font-family:'DM Mono',monospace;font-size:10px;color:var(--blue-mid);text-decoration:none;display:inline-flex;align-items:center;gap:3px;margin-top:6px;}
.nwlink:hover{text-decoration:underline;}
.nwdel{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);cursor:pointer;margin-left:8px;transition:color 0.15s;}
.nwdel:hover{color:var(--red);}

/* CHECKLIST */
.check-intro{background:var(--blue-pale);border:1px solid var(--border2);border-radius:10px;padding:16px 18px;margin-bottom:20px;font-size:12px;color:var(--muted2);line-height:1.7;}
.check-intro strong{color:var(--blue-dark);font-weight:600;}
.check-section{margin-bottom:22px;}
.check-section-title{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted2);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.check-item{display:flex;align-items:flex-start;gap:12px;padding:12px 16px;background:var(--s1);border:1px solid var(--border);border-radius:8px;margin-bottom:8px;transition:all 0.2s;cursor:pointer;box-shadow:0 1px 2px rgba(30,58,95,0.04);}
.check-item:hover{border-color:var(--blue-mid);}
.check-item.checked{background:rgba(42,122,75,0.05);border-color:rgba(42,122,75,0.3);}
.check-box{width:18px;height:18px;border-radius:4px;border:1.5px solid var(--s4);display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;transition:all 0.15s;}
.check-item.checked .check-box{background:var(--green);border-color:var(--green);}
.check-tick{color:#fff;font-size:11px;font-weight:700;display:none;}
.check-item.checked .check-tick{display:block;}
.check-text{flex:1;}
.check-label{font-size:13px;font-weight:500;margin-bottom:3px;color:var(--blue-dark);}
.check-item.checked .check-label{text-decoration:line-through;color:var(--muted2);}
.check-desc{font-size:11px;color:var(--muted2);line-height:1.5;}
.check-score{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:18px;margin-bottom:20px;display:flex;align-items:center;gap:20px;box-shadow:0 1px 3px rgba(30,58,95,0.06);}
.score-circle{width:64px;height:64px;border-radius:50%;background:var(--s2);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-direction:column;flex-shrink:0;}
.score-num{font-family:'DM Mono',monospace;font-size:18px;font-weight:500;color:var(--blue-dark);}
.score-denom{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);}
.score-text{flex:1;}
.score-title{font-weight:500;font-size:14px;margin-bottom:4px;color:var(--blue-dark);}
.score-sub{font-size:12px;color:var(--muted2);}
.score-bar{height:4px;background:var(--s3);border-radius:2px;margin-top:8px;overflow:hidden;}
.score-fill{height:100%;background:var(--blue-mid);border-radius:2px;transition:width 0.3s ease;}

/* SELL RULES */
.sell-intro{background:rgba(192,57,43,0.05);border:1px solid rgba(192,57,43,0.2);border-radius:10px;padding:16px 18px;margin-bottom:20px;font-size:12px;color:var(--muted2);line-height:1.7;}
.sell-intro strong{color:var(--red);font-weight:600;}
.sell-section{background:var(--s1);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 2px rgba(30,58,95,0.05);}
.sell-section-h{padding:12px 18px;background:var(--s2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.sell-section-icon{font-size:15px;}
.sell-section-label{font-family:'DM Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:0.12em;}
.sell-section-label.red{color:var(--red);}
.sell-section-label.gold{color:var(--gold);}
.sell-section-label.blue{color:var(--blue-mid);}
.sell-ta{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;line-height:1.75;resize:none;min-height:100px;padding:14px 18px;}
.sell-ta::placeholder{color:var(--muted);}
.sell-footer{padding:10px 18px;border-top:1px solid var(--border);background:var(--s2);display:flex;justify-content:space-between;align-items:center;}

/* BULL BEAR */
.bbg{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.bbc{background:var(--s1);border:1px solid var(--border);border-radius:10px;overflow:hidden;box-shadow:0 1px 2px rgba(30,58,95,0.05);}
.bbh{padding:12px 16px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);}
.bull .bbh{background:rgba(42,122,75,0.06);}
.bear .bbh{background:rgba(192,57,43,0.06);}
.bbicon{font-size:15px;}
.bblabel{font-family:'DM Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:0.12em;}
.bull .bblabel{color:var(--green)}.bear .bblabel{color:var(--red)}
.bbbody{padding:14px 16px;}
.bbta{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;line-height:1.75;resize:none;min-height:130px;}
.bbta::placeholder{color:var(--muted);}

/* SOURCES */
.sources-ta{width:100%;background:var(--s1);border:1px solid var(--border);border-radius:8px;padding:14px;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;line-height:1.75;resize:vertical;min-height:160px;outline:none;}
.sources-ta:focus{border-color:var(--blue-mid);}

/* PORTFOLIO GRID */
.pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
.pgc{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:16px;cursor:pointer;transition:all 0.2s;box-shadow:0 1px 3px rgba(30,58,95,0.06);}
.pgc:hover{border-color:var(--blue-mid);transform:translateY(-2px);box-shadow:0 4px 12px rgba(30,58,95,0.12);}
.pgc-top{display:flex;justify-content:space-between;margin-bottom:6px;}
.pgc-name{font-weight:600;font-size:13px;color:var(--blue-dark);}
.pgc-ticker{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted2);margin-top:1px;}
.pgc-price{font-family:'DM Mono',monospace;font-size:13px;color:var(--blue-mid);}
.pgc-thesis{font-size:11px;color:var(--muted2);margin-top:6px;line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
.pgc-stats{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;}
.pgc-stat{font-family:'DM Mono',monospace;font-size:9px;background:var(--s2);padding:2px 7px;border-radius:3px;color:var(--muted2);}
.pgc-add{display:flex;align-items:center;justify-content:center;border-style:dashed;color:var(--muted);font-size:13px;min-height:100px;}
.pgc-add:hover{color:var(--blue-mid);border-color:var(--blue-mid);}

/* ONEPAGER */
.op-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px;}
.op-badge{font-family:'DM Mono',monospace;font-size:10px;background:var(--s1);border:1px solid var(--border);padding:6px 14px;border-radius:20px;color:var(--muted2);}

/* MODAL */
.moverlay{position:fixed;inset:0;background:rgba(30,58,95,0.5);display:flex;align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity 0.2s;}
.moverlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--bg);border:1px solid var(--border2);border-radius:14px;padding:26px;width:400px;transform:translateY(12px);transition:transform 0.2s;box-shadow:0 12px 40px rgba(30,58,95,0.2);}
.moverlay.open .modal{transform:translateY(0);}
.modal-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:400;margin-bottom:18px;color:var(--blue-dark);}
.modal label{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;display:block;margin-bottom:5px;margin-top:12px;}
.modal input,.modal select{width:100%;background:#fff;border:1px solid var(--border2);border-radius:7px;padding:9px 12px;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;outline:none;transition:border-color 0.15s;}
.modal input:focus,.modal select:focus{border-color:var(--blue-mid);}
.mbtns{display:flex;gap:10px;margin-top:20px;}
.mbtns .btn,.mbtns .bg{flex:1;justify-content:center;}

/* ‚îÄ‚îÄ MACRO CALENDAR ‚îÄ‚îÄ */
.macro-cal{background:var(--s1);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:16px;box-shadow:0 1px 3px rgba(30,58,95,0.06);}
.macro-cal-h{padding:13px 18px;background:var(--s2);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.macro-cal-title{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted2);text-transform:uppercase;letter-spacing:0.12em;display:flex;align-items:center;gap:7px;}
.macro-cal-updated{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);}
.macro-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0;}
.macro-event{padding:12px 16px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);transition:background 0.15s;}
.macro-event:hover{background:var(--s2);}
.macro-event:nth-child(3n){border-right:none;}
.macro-event-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px;}
.macro-event-name{font-size:12px;font-weight:500;color:var(--blue-dark);}
.macro-event-badge{font-family:'DM Mono',monospace;font-size:9px;padding:2px 7px;border-radius:10px;white-space:nowrap;flex-shrink:0;}
.macro-fed{background:rgba(45,106,159,0.1);color:var(--blue-mid);border:1px solid rgba(45,106,159,0.2);}
.macro-riksbank{background:rgba(184,134,11,0.1);color:var(--gold);border:1px solid rgba(184,134,11,0.2);}
.macro-ecb{background:rgba(123,94,167,0.1);color:var(--co);border:1px solid rgba(123,94,167,0.2);}
.macro-event-date{font-family:'DM Mono',monospace;font-size:10px;color:var(--blue-mid);font-weight:500;}
.macro-event-days{font-family:'DM Mono',monospace;font-size:9px;margin-top:2px;}
.macro-event-note{font-size:11px;color:var(--muted2);margin-top:3px;line-height:1.4;}
.macro-past{opacity:0.45;}

/* ‚îÄ‚îÄ RISKS ‚îÄ‚îÄ */
.risk-section{margin-top:14px;}
.risk-label{font-family:'DM Mono',monospace;font-size:9px;color:var(--red);text-transform:uppercase;letter-spacing:0.15em;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
.risk-item{display:flex;align-items:flex-start;gap:8px;background:#fff;border:1px solid var(--border);border-radius:7px;padding:9px 12px;margin-bottom:6px;transition:border-color 0.15s;}
.risk-item:hover{border-color:rgba(192,57,43,0.3);}
.risk-dot{width:6px;height:6px;border-radius:50%;background:var(--red);flex-shrink:0;margin-top:5px;}
.risk-text{flex:1;font-size:12px;color:var(--text);line-height:1.6;background:transparent;border:none;outline:none;resize:none;font-family:'Sora',sans-serif;min-height:20px;}
.risk-del{font-size:11px;color:var(--muted);cursor:pointer;flex-shrink:0;transition:color 0.15s;padding:0 2px;}
.risk-del:hover{color:var(--red);}
.risk-empty{font-size:11px;color:var(--muted);font-style:italic;padding:6px 0;}
.risk-add-row{display:flex;gap:8px;margin-top:6px;}
.risk-add-input{flex:1;background:#fff;border:1px solid var(--border);border-radius:6px;padding:7px 10px;color:var(--text);font-family:'Sora',sans-serif;font-size:12px;outline:none;transition:border-color 0.15s;}
.risk-add-input:focus{border-color:rgba(192,57,43,0.4);}

/* ‚îÄ‚îÄ CATALYST TIMELINE ‚îÄ‚îÄ */
.cat-panel{background:var(--s1);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:12px;}
.cat-panel-h{padding:12px 16px;background:var(--s2);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.cat-panel-title{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted2);text-transform:uppercase;letter-spacing:0.12em;display:flex;align-items:center;gap:7px;}
.cat-panel-title span{font-size:13px;}
.cat-body{padding:12px 16px;}
.cat-empty{font-size:11px;color:var(--muted);font-style:italic;padding:4px 0 8px;}
.cat-item{display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);}
.cat-item:last-child{border-bottom:none;}
.cat-date-col{flex-shrink:0;width:80px;}
.cat-date{font-family:'DM Mono',monospace;font-size:10px;color:var(--blue-mid);font-weight:500;}
.cat-date.past{color:var(--muted);}
.cat-days{font-family:'DM Mono',monospace;font-size:9px;margin-top:2px;}
.cat-days.soon{color:var(--red);}
.cat-days.upcoming{color:var(--gold);}
.cat-days.future{color:var(--muted);}
.cat-days.past{color:var(--muted);}
.cat-content{flex:1;}
.cat-name{font-size:12px;font-weight:500;color:var(--blue-dark);}
.cat-note{font-size:11px;color:var(--muted2);margin-top:2px;line-height:1.5;}
.cat-type-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:4px;}
.cat-del{font-size:11px;color:var(--muted);cursor:pointer;padding:0 3px;transition:color 0.15s;flex-shrink:0;}
.cat-del:hover{color:var(--red);}
.cat-add-form{background:var(--s2);border-top:1px solid var(--border);padding:12px 16px;display:none;}
.cat-add-form.open{display:block;}
.cat-frow{display:grid;grid-template-columns:130px 1fr 120px;gap:8px;margin-bottom:8px;}

/* Type colors */
.cat-type-dot[data-t="rapport"]{background:#2d6a9f;}
.cat-type-dot[data-t="rantebesked"]{background:#b8860b;}
.cat-type-dot[data-t="utdelning"]{background:#2a7a4b;}
.cat-type-dot[data-t="produkt"]{background:#7b5ea7;}
.cat-type-dot[data-t="makro"]{background:#c0392b;}
.cat-type-dot[data-t="bolagsstamma"]{background:#4a90c4;}
.cat-type-dot[data-t="ovrigt"]{background:#8090a8;}

@keyframes spin{to{transform:rotate(360deg)}}
.search-result-item{padding:11px 14px;cursor:pointer;border-bottom:1px solid var(--border);transition:background 0.12s;}
.search-result-item:last-child{border-bottom:none;}
.search-result-item:hover{background:var(--blue-pale);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.typing span{display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--muted2);margin:0 2px;animation:pulse 1.2s ease infinite;}
.typing span:nth-child(2){animation-delay:0.2s;}
.typing span:nth-child(3){animation-delay:0.4s;}
</style>
</head>
<body>

<div class="layout">
<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="slogo"><div class="slogo-t">Portf√∂ljvy</div><div class="slogo-s">Dina investeringar</div></div>
  <div class="sbody">
    <div class="nsec">√ñversikt</div>
    <div class="ni active" onclick="navPage('dash',this)"><span style="font-size:12px">‚óà</span>Dashboard</div>
    <div class="ni" onclick="navPage('onepager',this)"><span style="font-size:12px">‚óé</span>Nyheter ¬∑ Onepager</div>
    <div class="nsec">Portf√∂lj</div>
    <div class="ni" onclick="navPage('portfolio',this)"><span style="font-size:12px">‚ñ¶</span>Alla bolag</div>
    <div id="stockNav"></div>
    <div class="addbtn" onclick="openModal()"><span style="font-size:15px">+</span> L√§gg till bolag</div>
  </div>
</aside>

<!-- MAIN -->
<div class="main"><div class="content">

<!-- DASHBOARD -->
<div class="page active" id="page-dash">
  <div class="ph"><div class="ph-l"><small>V√§lkommen tillbaka</small><div class="ph-title">Dashboard</div></div><div class="ph-r" id="dashDate"></div></div>
  <div class="stats">
    <div class="stat"><div class="sl">Antal innehav</div><div class="sv" id="s-count">0</div><div class="ss" id="s-break">‚Äî SE ¬∑ ‚Äî US</div></div>
    <div class="stat"><div class="sl">Med grundtes</div><div class="sv" id="s-thesis">0</div><div class="ss">Bolag med analys</div></div>
    <div class="stat"><div class="sl">Anteckningar</div><div class="sv" id="s-notes">0</div><div class="ss">Totalt sparade</div></div>
    <div class="stat"><div class="sl">Nyheter sparade</div><div class="sv" id="s-news">0</div><div class="ss">Totalt</div></div>
  </div>
  <!-- MACRO CALENDAR -->
  <div class="macro-cal">
    <div class="macro-cal-h">
      <div class="macro-cal-title"><span>üåç</span>Makrokalender ‚Äî Fed ¬∑ Riksbanken ¬∑ ECB</div>
      <div class="macro-cal-updated" id="macroUpdated"></div>
    </div>
    <div class="macro-grid" id="macroGrid"></div>
  </div>
  <div class="g2">
    <div class="card"><div class="ct">Innehav ¬∑ Snabbvy</div><table class="ht"><thead><tr><th>Bolag</th><th>Ticker</th><th>B√∂rs</th><th>Kurs</th></tr></thead><tbody id="dashTbody"></tbody></table></div>
    <div class="card"><div class="ct">Portf√∂lj ¬∑ Simulerad trend</div><div class="chart" id="chartBars"></div></div>
  </div>
</div>

<!-- ONEPAGER -->
<div class="page" id="page-onepager">
  <div class="ph"><div class="ph-l"><small>Daglig AI-sammanfattning</small><div class="ph-title">Nyheter ¬∑ Onepager</div></div><div class="ph-r" id="opDate"></div></div>
  <div class="op-controls">
    <div class="op-badge" id="opBadge">Generera f√∂r att h√§mta nyheter anpassade till din portf√∂lj</div>
    <div class="gap8"><button class="bg">Exportera PDF</button><button class="btn" onclick="genOnepager()">‚ü≥ Generera nyheter</button></div>
  </div>
  <div id="opContent"><div class="news-empty"><div style="font-size:28px;margin-bottom:8px">‚óé</div><div style="font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.08em;color:var(--muted)">Inga nyheter genererade</div><div style="font-size:12px;margin-top:6px;color:var(--muted)">L√§gg till bolag och tryck p√• "Generera nyheter"</div></div></div>
</div>

<!-- PORTFOLIO -->
<div class="page" id="page-portfolio">
  <div class="ph"><div class="ph-l"><small>Portf√∂lj</small><div class="ph-title">Alla bolag</div></div><button class="btn" onclick="openModal()">+ L√§gg till bolag</button></div>
  <div class="pgrid" id="pgrid"></div>
</div>

<!-- STOCK DETAIL -->
<div class="page" id="page-stock"><div id="stockDetail"></div></div>

</div></div></div>

<!-- MODAL -->
<div class="moverlay" id="moverlay">
  <div class="modal" style="width:480px">
    <div class="modal-title">L√§gg till bolag</div>

    <!-- STEP 1: SEARCH -->
    <div id="modal-step1">
      <label>S√∂k bolag</label>
      <div style="position:relative">
        <input id="m-search" placeholder="Skriv bolagsnamn eller ticker, t.ex. Ericsson..." autocomplete="off"
          oninput="searchCompany(this.value)"
          style="width:100%;background:#fff;border:1px solid var(--border2);border-radius:7px;padding:9px 12px;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;outline:none;transition:border-color 0.15s;">
        <div id="search-spinner" style="display:none;position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:14px;animation:spin 1s linear infinite;color:var(--muted)">‚óå</div>
      </div>
      <div id="search-results" style="margin-top:8px;max-height:260px;overflow-y:auto;border-radius:8px;border:1px solid var(--border);display:none;background:#fff;box-shadow:0 4px 12px rgba(30,58,95,0.1)"></div>
      <div id="search-hint" style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-top:8px;text-align:center">
        S√∂ker i inbyggd lista ¬∑ L√§gg till B√∂rsdata-nyckel f√∂r full t√§ckning
      </div>

        <!-- B√ñRSDATA KEY -->
      <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em">B√∂rsdata API-nyckel</div>
          <div id="modal-key-status" style="font-family:'DM Mono',monospace;font-size:9px;color:var(--muted)">Ingen nyckel ‚Äî s√∂ker med fallback</div>
        </div>
        <input id="m-bd-key" placeholder="Din B√∂rsdata Pro API-nyckel..." type="password"
          style="width:100%;background:#fff;border:1px solid var(--border);border-radius:6px;padding:7px 10px;color:var(--text);font-family:'DM Mono',monospace;font-size:11px;outline:none;transition:border-color 0.15s;"
          oninput="saveBorsdataKey(this.value)">
        <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);margin-top:4px">borsdata.se ¬∑ Pro-version ¬∑ Ut√∂kar s√∂kning med hela B√∂rsdata-databasen</div>
      </div>

      <!-- MANUAL FALLBACK -->
      <div style="margin-top:10px">
        <button class="bg bsm" onclick="toggleManualAdd()" style="width:100%;justify-content:center;font-size:11px">
          Hittar du inte bolaget? L√§gg till manuellt ‚Üí
        </button>
        <div id="manual-add-form" style="display:none;margin-top:10px;padding:12px;background:var(--s2);border-radius:8px;border:1px dashed var(--border2)">
          <div class="frow" style="margin-bottom:8px">
            <input class="fi" id="man-name" placeholder="Bolagsnamn *">
            <input class="fi" id="man-ticker" placeholder="Ticker * (t.ex. AAPL)">
          </div>
          <select class="fsel" style="width:100%;margin-bottom:8px" id="man-exch">
            <option>Stockholmsb√∂rsen STO</option>
            <option>NASDAQ</option>
            <option>NYSE</option>
            <option>Annan</option>
          </select>
          <button class="btn bsm" onclick="addManually()">L√§gg till manuellt</button>
        </div>
      </div>
    </div>

    <!-- STEP 2: CONFIRM SELECTED COMPANY -->
    <div id="modal-step2" style="display:none">
      <div id="selected-company-card" style="background:var(--blue-pale);border:1px solid var(--border2);border-radius:10px;padding:16px;margin-bottom:14px"></div>
      <label>Aktuell kurs (valfritt)</label>
      <input id="m-price" placeholder="t.ex. 80.42"
        style="width:100%;background:#fff;border:1px solid var(--border2);border-radius:7px;padding:9px 12px;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;outline:none;">
      <button class="bg bsm" onclick="resetModal()" style="margin-top:10px;display:flex;align-items:center;gap:5px">‚Üê S√∂k igen</button>
    </div>

    <div class="mbtns" style="margin-top:16px">
      <button class="bg" onclick="closeModal()">Avbryt</button>
      <button class="btn" id="modal-add-btn" onclick="addStock()" disabled style="opacity:0.4">V√§lj ett bolag f√∂rst</button>
    </div>
  </div>
</div>

<script>
let stocks=[],activeId=null,activeTab='anteckningar',noteFilter='all',apiKey='',chatHistory=[];
const CL={financial:'Finansiellt',market:'Marknadsinsikt',risk:'Risk',macro:'Makro',misc:'√ñvrigt'};
const CC={financial:'var(--cf)',market:'var(--cm)',risk:'var(--cr)',macro:'var(--cma)',misc:'var(--co)'};
const CHECKLIST=[
  {id:'c1',section:'Grundtes',label:'Grundtesen √§r fortfarande intakt',desc:'Har n√•got fundamentalt f√∂r√§ndrats sedan du k√∂pte? √Ñr de ursprungliga sk√§len fortfarande giltiga?'},
  {id:'c2',section:'Grundtes',label:'Inga tes-brott har intr√§ffat',desc:'G√• igenom dina s√§ljregler. Har n√•gon av dina definierade tes-brottspunkter utl√∂sts?'},
  {id:'c3',section:'K√§nslor',label:'Jag agerar p√• fundamenta, inte pris',desc:'√Ñr beslutet drivet av bolagets v√§rde ‚Äî eller av att kursen r√∂rt sig och du reagerar k√§nslom√§ssigt?'},
  {id:'c4',section:'K√§nslor',label:'Jag har inte kolat kursen de senaste 30 min',desc:'Om du precis sett en stor r√∂relse ‚Äî v√§nta. L√•t inte en kursr√∂relse styra ditt beslut.'},
  {id:'c5',section:'Analys',label:'Bear-caset √§r k√§nt och accepterat',desc:'√Ñr du medveten om vad som kan g√• fel? √Ñr nedsidan acceptabel givet din portf√∂ljstorlek?'},
  {id:'c6',section:'Analys',label:'Tidshorisonten st√§mmer med tesen',desc:'St√§mmer detta med varf√∂r du ursprungligen k√∂pte? Kort- eller l√•ngsiktigt?'},
  {id:'c7',section:'Beslut',label:'Jag √•ngrar inte beslutet imorgon om jag har fel',desc:'Kan du leva med beslutet oavsett utfall, givet den information du har idag?'},
];

// ‚ïê‚ïê MAKROKALENDER ‚ïê‚ïê
// Uppdatera datumen h√§r n√§r nya m√∂ten annonseras.
// Fed: presskonferens efter FOMC-m√∂te (oftast 19:00 ET = 01:00 svensk tid n√§sta dag)
// Riksbanken: penningpolitiskt beslut
// ECB: r√§ntebesked
const MACRO_EVENTS = [
  // ‚îÄ‚îÄ FED 2025 ‚îÄ‚îÄ
  {date:'2025-03-19',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te ¬∑ Presskonferens Powell'},
  {date:'2025-05-07',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te ¬∑ Presskonferens Powell'},
  {date:'2025-06-18',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te ¬∑ Summary of Economic Projections'},
  {date:'2025-07-30',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te'},
  {date:'2025-09-17',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te ¬∑ Summary of Economic Projections'},
  {date:'2025-10-29',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te'},
  {date:'2025-12-10',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te ¬∑ Summary of Economic Projections'},
  // ‚îÄ‚îÄ FED 2026 ‚îÄ‚îÄ
  {date:'2026-01-28',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te'},
  {date:'2026-03-18',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te ¬∑ Summary of Economic Projections'},
  {date:'2026-04-29',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te'},
  {date:'2026-06-17',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te ¬∑ Summary of Economic Projections'},
  {date:'2026-07-29',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te'},
  {date:'2026-09-16',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te ¬∑ Summary of Economic Projections'},
  {date:'2026-11-04',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te'},
  {date:'2026-12-16',name:'Fed r√§ntebesked',org:'fed',note:'FOMC-m√∂te ¬∑ Summary of Economic Projections'},
  // ‚îÄ‚îÄ RIKSBANKEN 2025 ‚îÄ‚îÄ
  {date:'2025-03-20',name:'Riksbanken r√§ntebesked',org:'riksbank',note:'Penningpolitiskt beslut'},
  {date:'2025-05-08',name:'Riksbanken r√§ntebesked',org:'riksbank',note:'Penningpolitiskt beslut ¬∑ Rapport'},
  {date:'2025-06-26',name:'Riksbanken r√§ntebesked',org:'riksbank',note:'Penningpolitiskt beslut'},
  {date:'2025-09-18',name:'Riksbanken r√§ntebesked',org:'riksbank',note:'Penningpolitiskt beslut ¬∑ Rapport'},
  {date:'2025-11-06',name:'Riksbanken r√§ntebesked',org:'riksbank',note:'Penningpolitiskt beslut'},
  // ‚îÄ‚îÄ RIKSBANKEN 2026 ‚îÄ‚îÄ
  {date:'2026-02-05',name:'Riksbanken r√§ntebesked',org:'riksbank',note:'Penningpolitiskt beslut ¬∑ Rapport'},
  {date:'2026-03-26',name:'Riksbanken r√§ntebesked',org:'riksbank',note:'Penningpolitiskt beslut'},
  {date:'2026-05-07',name:'Riksbanken r√§ntebesked',org:'riksbank',note:'Penningpolitiskt beslut ¬∑ Rapport'},
  {date:'2026-06-25',name:'Riksbanken r√§ntebesked',org:'riksbank',note:'Penningpolitiskt beslut'},
  {date:'2026-09-17',name:'Riksbanken r√§ntebesked',org:'riksbank',note:'Penningpolitiskt beslut ¬∑ Rapport'},
  {date:'2026-11-05',name:'Riksbanken r√§ntebesked',org:'riksbank',note:'Penningpolitiskt beslut'},
  // ‚îÄ‚îÄ ECB 2025 ‚îÄ‚îÄ
  {date:'2025-04-17',name:'ECB r√§ntebesked',org:'ecb',note:'Penningpolitiskt m√∂te ¬∑ Lagarde presskonferens'},
  {date:'2025-06-05',name:'ECB r√§ntebesked',org:'ecb',note:'Penningpolitiskt m√∂te'},
  {date:'2025-07-24',name:'ECB r√§ntebesked',org:'ecb',note:'Penningpolitiskt m√∂te'},
  {date:'2025-09-11',name:'ECB r√§ntebesked',org:'ecb',note:'Penningpolitiskt m√∂te'},
  {date:'2025-10-30',name:'ECB r√§ntebesked',org:'ecb',note:'Penningpolitiskt m√∂te'},
  {date:'2025-12-18',name:'ECB r√§ntebesked',org:'ecb',note:'Penningpolitiskt m√∂te'},
  // ‚îÄ‚îÄ ECB 2026 ‚îÄ‚îÄ
  {date:'2026-01-22',name:'ECB r√§ntebesked',org:'ecb',note:'Penningpolitiskt m√∂te'},
  {date:'2026-03-05',name:'ECB r√§ntebesked',org:'ecb',note:'Penningpolitiskt m√∂te'},
  {date:'2026-04-16',name:'ECB r√§ntebesked',org:'ecb',note:'Penningpolitiskt m√∂te'},
  {date:'2026-06-04',name:'ECB r√§ntebesked',org:'ecb',note:'Penningpolitiskt m√∂te'},
  {date:'2026-07-23',name:'ECB r√§ntebesked',org:'ecb',note:'Penningpolitiskt m√∂te'},
  {date:'2026-09-10',name:'ECB r√§ntebesked',org:'ecb',note:'Penningpolitiskt m√∂te'},
  {date:'2026-10-29',name:'ECB r√§ntebesked',org:'ecb',note:'Penningpolitiskt m√∂te'},
  {date:'2026-12-17',name:'ECB r√§ntebesked',org:'ecb',note:'Penningpolitiskt m√∂te'},
];

// Uppdaterades senast: februari 2026
const MACRO_LAST_UPDATED = 'Uppdaterad feb 2026';

function renderMacroCalendar(){
  const grid = document.getElementById('macroGrid');
  const updEl = document.getElementById('macroUpdated');
  if(!grid) return;
  if(updEl) updEl.textContent = MACRO_LAST_UPDATED;

  const today = new Date(); today.setHours(0,0,0,0);

  // Show: last 1 past event per org + all upcoming, max 12 total upcoming
  const sorted = [...MACRO_EVENTS].sort((a,b)=>new Date(a.date)-new Date(b.date));

  // Find last past per org
  const orgs = ['fed','riksbank','ecb'];
  let toShow = [];
  orgs.forEach(org=>{
    const past = sorted.filter(e=>e.org===org && new Date(e.date)<today);
    if(past.length) toShow.push(past[past.length-1]);
  });
  // Add upcoming (next 9)
  const upcoming = sorted.filter(e=>new Date(e.date)>=today).slice(0,9);
  toShow = [...toShow, ...upcoming];
  // Sort again
  toShow.sort((a,b)=>new Date(a.date)-new Date(b.date));

  grid.innerHTML = toShow.map(e=>{
    const d = new Date(e.date);
    const diff = Math.round((d-today)/(1000*60*60*24));
    const isPast = diff < 0;
    let daysLabel='', daysClass='';
    if(isPast){ daysLabel=`${Math.abs(diff)}d sedan`; daysClass='macro-past'; }
    else if(diff===0){ daysLabel='Idag'; daysClass=''; }
    else if(diff===1){ daysLabel='Imorgon'; daysClass=''; }
    else if(diff<=7){ daysLabel=`Om ${diff} dagar`; daysClass=''; }
    else if(diff<=30){ daysLabel=`Om ${diff} dagar`; daysClass=''; }
    else { daysLabel=`Om ${diff} dagar`; daysClass=''; }

    const badgeClass = e.org==='fed'?'macro-fed':e.org==='riksbank'?'macro-riksbank':'macro-ecb';
    const badgeLabel = e.org==='fed'?'Fed':e.org==='riksbank'?'Riksbanken':'ECB';
    const daysColor = isPast?'var(--muted)':diff<=7?'var(--red)':diff<=30?'var(--gold)':'var(--muted2)';

    return `<div class="macro-event${isPast?' macro-past':''}">
      <div class="macro-event-top">
        <div class="macro-event-name">${e.name}</div>
        <div class="macro-event-badge ${badgeClass}">${badgeLabel}</div>
      </div>
      <div class="macro-event-date">${d.toLocaleDateString('sv-SE',{day:'numeric',month:'long',year:'numeric'})}</div>
      <div class="macro-event-days" style="color:${daysColor}">${daysLabel}</div>
      ${e.note?`<div class="macro-event-note">${e.note}</div>`:''}
    </div>`;
  }).join('');
}

function load(){try{const r=localStorage.getItem('pv5-stocks');if(r)stocks=JSON.parse(r);}catch(e){stocks=[];}try{const r=localStorage.getItem('pv5-apikey');if(r)apiKey=r;}catch(e){}boot();}
function save(){try{localStorage.setItem('pv5-stocks',JSON.stringify(stocks));}catch(e){}}
function saveApiKey(k){apiKey=k;try{localStorage.setItem('pv5-apikey',k);}catch(e){}}

function navPage(id,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  document.querySelectorAll('.ni,.sni').forEach(n=>n.classList.remove('active'));
  if(el)el.classList.add('active');
  if(id==='dash')renderDash();
  if(id==='portfolio')renderPgrid();
  if(id==='onepager')document.getElementById('opDate').innerHTML=new Date().toLocaleDateString('sv-SE',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).toUpperCase();
}
function navStock(id,el){
  activeId=id;activeTab='anteckningar';noteFilter='all';chatHistory=[];
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-stock').classList.add('active');
  document.querySelectorAll('.ni,.sni').forEach(n=>n.classList.remove('active'));
  if(el)el.classList.add('active');
  renderStock();
}
function renderSidebar(){document.getElementById('stockNav').innerHTML=stocks.map(s=>`<div class="sni${activeId===s.id?' active':''}" onclick="navStock('${s.id}',this)"><span style="font-size:11px">${s.exchange.includes('üá∏üá™')?'üá∏üá™':'üá∫üá∏'}</span><span class="sni-name">${s.name}</span>${s.price?`<span class="sni-price">${s.price}</span>`:''}</div>`).join('');}

function renderDash(){
  renderMacroCalendar();
  document.getElementById('dashDate').innerHTML=new Date().toLocaleDateString('sv-SE',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).toUpperCase();
  const se=stocks.filter(s=>s.exchange.includes('üá∏üá™')).length;
  document.getElementById('s-count').textContent=stocks.length;
  document.getElementById('s-break').textContent=`${se} SE ¬∑ ${stocks.length-se} US`;
  document.getElementById('s-thesis').textContent=stocks.filter(s=>s.thesis&&s.thesis.trim().length>5).length;
  document.getElementById('s-notes').textContent=stocks.reduce((a,s)=>a+(s.notes||[]).length,0);
  document.getElementById('s-news').textContent=stocks.reduce((a,s)=>a+(s.news||[]).length,0);
  const tb=document.getElementById('dashTbody');
  tb.innerHTML=stocks.length?stocks.map(s=>`<tr onclick="navStock('${s.id}')"><td><div class="sn">${s.exchange.includes('üá∏üá™')?'üá∏üá™':'üá∫üá∏'} ${s.name}</div></td><td><div class="st">${s.ticker}</div></td><td style="font-size:10px;color:var(--muted2)">${s.exchange.replace(/üá∏üá™|üá∫üá∏/g,'').trim()}</td><td>${s.price||'‚Äî'}</td></tr>`).join(''):`<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--muted)">Inga bolag √§nnu ‚Äî tryck + i menyn</td></tr>`;
  const c=document.getElementById('chartBars'),v=[55,60,57,65,70,68,75,72,80,77,85,82,88,84,92,88,95,91,98,94,100,97,104,101],mn=Math.min(...v),mx=Math.max(...v);
  c.innerHTML=v.map((x,i)=>`<div class="bar${i===v.length-1?' hi':''}" style="height:${((x-mn)/(mx-mn)*68+10).toFixed(1)}px"></div>`).join('');
}
function renderPgrid(){document.getElementById('pgrid').innerHTML=stocks.map(s=>`<div class="pgc" onclick="navStock('${s.id}')"><div class="pgc-top"><div><div class="pgc-name">${s.exchange.includes('üá∏üá™')?'üá∏üá™':'üá∫üá∏'} ${s.name}</div><div class="pgc-ticker">${s.ticker}</div></div><div class="pgc-price">${s.price||'‚Äî'}</div></div><div class="pgc-thesis">${s.thesis||'Ingen grundtes √§nnu...'}</div><div class="pgc-stats"><span class="pgc-stat">${(s.notes||[]).length} noter</span><span class="pgc-stat">${(s.news||[]).length} nyheter</span>${s.sell_thesis?'<span class="pgc-stat" style="color:var(--red)">S√§ljregler ‚úì</span>':''}</div></div>`).join('')+`<div class="pgc pgc-add" onclick="openModal()">+ L√§gg till bolag</div>`;}

function renderStock(){
  const s=stocks.find(x=>x.id===activeId);if(!s)return;
  const flag=s.exchange.includes('üá∏üá™')?'üá∏üá™':'üá∫üá∏';
  document.getElementById('stockDetail').innerHTML=`
<div class="hero" id="stockHero">
  <div class="hero-top">
    <div style="flex:1">
      <span class="hflag">${flag}</span>
      <div class="hname">${s.name}</div>
      <div class="hmeta">
        <span class="hmi">${s.ticker}</span>
        <span class="hmi">¬∑</span>
        <span class="hmi">${s.exchange}</span>
        ${s.sector?`<span class="hmi">¬∑</span><span class="hmi">${s.sector}</span>`:''}
        ${s.bdConnected?`<span class="hbd-badge">‚úì B√∂rsdata</span>`:''}
      </div>
      <div id="hero-desc">
        ${s.description
          ? `<div class="hdesc" style="margin-top:10px">${s.description}</div>`
          : s.bdConnected
            ? `<div class="hdesc" style="margin-top:10px;color:rgba(245,240,232,0.3);font-style:italic">Laddar bolagsbeskrivning...</div>`
            : `<div class="hdesc" style="margin-top:10px;color:rgba(245,240,232,0.3);font-style:italic">Ingen beskrivning ‚Äî koppla B√∂rsdata f√∂r automatisk info</div>`
        }
        ${s.ceo ? `<div class="hceo">VD: <span class="hceo-name">${s.ceo}</span></div>` : ''}
      </div>
    </div>
    <div style="text-align:right;flex-shrink:0">
      <div class="hprice-label">St√§ngningskurs</div>
      <div class="hprice" id="hero-close-price">${s.closePrice||s.price||'‚Äî'}</div>
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:rgba(245,240,232,0.3);margin-top:3px" id="hero-price-date">${s.closePriceDate?'St√§ngde '+s.closePriceDate:s.closePrice?'':'Uppdateras via B√∂rsdata'}</div>
      <div style="margin-top:10px;display:flex;gap:6px;justify-content:flex-end">
        <button class="bg bsm" style="color:rgba(245,240,232,0.6);border-color:rgba(245,240,232,0.15);font-size:10px" onclick="fetchClosePrice()">‚ü≥ H√§mta kurs</button>
        <button class="bg bsm" style="color:rgba(245,240,232,0.6);border-color:rgba(245,240,232,0.15);font-size:10px" onclick="editGav()">GAV ‚úé</button>
      </div>
    </div>
  </div>
  <div class="hero-bottom">
    <div class="hstat">
      <div class="hstat-label">GAV</div>
      <div class="hstat-val" id="hero-gav">${s.gav||'‚Äî'}</div>
      <div class="hstat-sub">${s.gav?s.currency||'':'Ange anskaffningskurs'}</div>
    </div>
    <div class="hstat">
      <div class="hstat-label">Utveckling</div>
      ${(()=>{
        const cp=parseFloat(s.closePrice||s.price);
        const gav=parseFloat(s.gav);
        if(cp&&gav){
          const pct=((cp-gav)/gav*100);
          const sign=pct>=0?'+':'';
          return `<div class="hstat-val ${pct>=0?'pos':'neg'}" id="hero-dev">${sign}${pct.toFixed(1)}%</div><div class="hstat-sub">${pct>=0?'Vinst':'F√∂rlust'} sedan k√∂p</div>`;
        }
        return `<div class="hstat-val" id="hero-dev" style="color:rgba(245,240,232,0.25)">‚Äî</div><div class="hstat-sub">Ange GAV och kurs</div>`;
      })()}
    </div>
    <div class="hstat">
      <div class="hstat-label">Senaste st√§ngning</div>
      <div class="hstat-val" id="hero-close2">${s.closePrice||'‚Äî'}</div>
      <div class="hstat-sub">${s.closePriceDate||'G√•rdagens kurs'}</div>
    </div>
    <div class="hstat">
      <div class="hstat-label">Valuta</div>
      <div class="hstat-val">${s.currency||'‚Äî'}</div>
      <div class="hstat-sub">${s.country==='SE'?'Svensk aktie':'Utl√§ndsk aktie'}</div>
    </div>
  </div>
</div>
<div class="tags" id="stockTags">${renderTags(s)}</div>
<div class="stabs">
  <div class="stab${activeTab==='anteckningar'?' active':''}" onclick="swTab('anteckningar',this)">üìù Anteckningar</div>
  <div class="stab${activeTab==='nyheter'?' active':''}" onclick="swTab('nyheter',this)">üì∞ Nyheter</div>
  <div class="stab${activeTab==='checklist'?' active':''}" onclick="swTab('checklist',this)">‚úÖ Pre-trade checklist</div>
  <div class="stab${activeTab==='saljregler'?' active':''}" onclick="swTab('saljregler',this)">‚ö†Ô∏è S√§ljregler</div>
  <div class="stab${activeTab==='bullbear'?' active':''}" onclick="swTab('bullbear',this)">‚Üë‚Üì Bull / Bear</div>
  <div class="stab${activeTab==='k√§llor'?' active':''}" onclick="swTab('k√§llor',this)">‚äû K√§llor</div>
</div>

<div class="tc${activeTab==='anteckningar'?' active':''}" id="tab-anteckningar">
  <div class="split">
    <div class="split-left">
      <div class="np-header">
        <span class="np-title">üìù Grundtes & Anteckningar</span>
        <div class="nfilters">
          <div class="nf active" data-c="all" onclick="filterN('all',this)">Alla</div>
          <div class="nf" data-c="financial" onclick="filterN('financial',this)">üíπ</div>
          <div class="nf" data-c="market" onclick="filterN('market',this)">üåê</div>
          <div class="nf" data-c="risk" onclick="filterN('risk',this)">‚ö†Ô∏è</div>
          <div class="nf" data-c="macro" onclick="filterN('macro',this)">üåç</div>
        </div>
      </div>
      <div class="np-body">
        <div class="tbox">
          <div class="tbox-label"><span>‚¨° Grundtes</span><button class="bg bsm" onclick="saveRevision()">+ Spara revision</button></div>
          <textarea class="tbox-ta" id="thesis-ta" placeholder="Varf√∂r √§ger du detta bolag? Vad √§r din √∂vertygelse? Vad m√•ste vara sant f√∂r att tesen h√•ller?">${s.thesis||''}</textarea>
          <div class="tbox-footer"><span class="saved-hint" id="thesis-hint">Spara f√∂r att logga en ny version</span><button class="btn bsm" onclick="saveThesis()">Spara grundtes</button></div>
          <!-- RISKS -->
          <div class="risk-section">
            <div class="risk-label">
              <span>‚ö† Risker</span>
              <span style="color:var(--muted);font-size:9px">${(s.risks||[]).length} identifierade</span>
            </div>
            <div id="risksList">${renderRisks(s)}</div>
            <div class="risk-add-row">
              <input class="risk-add-input" id="risk-input" placeholder="L√§gg till en risk..." onkeydown="riskKeydown(event)">
              <button class="btn bsm" onclick="addRisk()" style="flex-shrink:0">+</button>
            </div>
          </div>
        </div>
        ${(s.revisions||[]).length?`<div class="revlog"><div class="revlog-title"><span>Revisionslogg</span><span>${(s.revisions||[]).length} versioner</span></div>${(s.revisions||[]).slice().reverse().map(r=>`<div class="reventry"><div class="reventry-date">${r.date}</div>${r.text}</div>`).join('')}</div>`:''}
        <div style="height:1px;background:var(--border);margin:14px 0"></div>
        <div class="anf" id="addNoteForm">
          <div class="frow"><input class="fi" id="note-title" placeholder="Titel..."><select class="fsel" id="note-cat"><option value="financial">üíπ Finansiellt</option><option value="market">üåê Marknadsinsikt</option><option value="risk">‚ö†Ô∏è Risk</option><option value="macro">üåç Makro / Ledande indikator</option><option value="misc">üìå √ñvrigt</option></select></div>
          <textarea class="fta" id="note-body" placeholder="Din anteckning..."></textarea>
          <div class="gap8"><button class="btn bsm" onclick="saveNote()">Spara</button><button class="bg bsm" onclick="toggleAnf()">Avbryt</button></div>
        </div>
        <div style="margin-bottom:12px"><button class="btn bsm" onclick="toggleAnf()">+ Ny anteckning</button></div>
        <div id="notesList">${renderNotes(s)}</div>
      </div>
    </div>
    <div class="split-right" style="display:flex;flex-direction:column;overflow:hidden;">
      <!-- CATALYST TIMELINE -->
      <div class="cat-panel" style="flex-shrink:0;border-radius:0;border-left:none;border-right:none;border-top:none;">
        <div class="cat-panel-h">
          <div class="cat-panel-title"><span>üìÖ</span>Katalysatorer & kommande h√§ndelser</div>
          <button class="bg bsm" onclick="toggleCatForm()">+ L√§gg till</button>
        </div>
        <div class="cat-body" id="catBody" style="max-height:220px;overflow-y:auto;">${renderCatalysts(s)}</div>
        <div class="cat-add-form" id="catAddForm">
          <div class="cat-frow">
            <input class="fi" id="cat-date" type="date" style="font-size:11px">
            <input class="fi" id="cat-name" placeholder="H√§ndelse (t.ex. Q2-rapport, Fed-m√∂te...)" style="font-size:11px">
            <select class="fsel" id="cat-type" style="font-size:11px">
              <option value="rapport">üìä Rapport</option>
              <option value="rantebesked">üè¶ R√§ntebesked</option>
              <option value="utdelning">üí∞ Utdelning</option>
              <option value="produkt">üöÄ Produkt/lansering</option>
              <option value="makro">üåç Makroh√§ndelse</option>
              <option value="bolagsstamma">üó≥Ô∏è Bolagsst√§mma</option>
              <option value="ovrigt">üìå √ñvrigt</option>
            </select>
          </div>
          <textarea class="fi" id="cat-note" placeholder="Kort notering (valfritt)..." style="width:100%;min-height:40px;resize:none;font-size:11px;margin-bottom:8px"></textarea>
          <div class="gap8">
            <button class="btn bsm" onclick="saveCatalyst()">Spara</button>
            <button class="bg bsm" onclick="toggleCatForm()">Avbryt</button>
          </div>
        </div>
      </div>
      <!-- CHAT -->
      <div class="chat-header">
        <span class="chat-title">ü§ñ AI-bollplank</span>
        <span class="chat-status${apiKey?' connected':''}" id="chatStatus">${apiKey?'Ansluten':'Ej ansluten'}</span>
      </div>
      <div class="chat-messages" id="chatMessages">
        ${apiKey?`<div class="msg msg-ai"><div class="msg-name">Claude</div><div class="msg-bubble">Hej! Jag har l√§st din grundtes och anteckningar om <strong>${s.name}</strong>. Vad vill du diskutera?</div></div>`:`<div class="chat-api-notice"><div class="can-icon">üîë</div><div class="can-title">Koppla in Claude API</div><div class="can-body">Ange din API-nyckel f√∂r att aktivera AI-bollplanket. Nyckeln sparas lokalt.<br><br>Skaffa nyckel p√• <strong>console.anthropic.com</strong></div><input class="api-input" id="apiKeyInput" placeholder="sk-ant-..." type="password"><button class="btn bsm" onclick="connectApi()" style="width:100%;justify-content:center">Anslut</button></div>`}
      </div>
      <div class="chat-input-area">
        <div class="chat-input-row">
          <textarea class="chat-ta" id="chatInput" placeholder="${apiKey?'St√§ll en fr√•ga om '+s.name+'...':'Anslut API-nyckel ovan...'}" ${apiKey?'':'disabled'} onkeydown="handleChatKey(event)"></textarea>
          <button class="chat-send" onclick="sendChat()" ${apiKey?'':'disabled'}>‚Üë</button>
        </div>
        <div class="chat-hint">Kontexten inkluderar din grundtes och anteckningar automatiskt</div>
      </div>
    </div>
  </div>
</div>

<div class="tc${activeTab==='nyheter'?' active':''}" id="tab-nyheter">
  <div class="news-h"><span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted2);text-transform:uppercase;letter-spacing:0.12em">Nyheter & insikter ‚Äî ${s.name}</span>
  <div class="gap8"><button class="bg bsm" onclick="toggleAnwf()">+ L√§gg till</button><button class="btn bsm" onclick="alert('Koppla in Claude API f√∂r automatiska nyheter!')">‚ü≥ H√§mta AI-nyheter</button></div></div>
  <div class="anwf" id="addNewsForm">
    <div class="frow"><input class="fi" id="nw-title" placeholder="Rubrik..."><select class="fsel" id="nw-impact"><option value="h">üî¥ H√∂g p√•verkan</option><option value="m">üü° Medel</option><option value="l">üü¢ Positiv</option></select></div>
    <textarea class="fta" id="nw-body" placeholder="Sammanfattning..."></textarea>
    <div class="frow" style="margin-bottom:8px"><input class="fi" id="nw-url" placeholder="L√§nk (valfritt)"><input class="fi" id="nw-tags" placeholder="Taggar, kommasep."></div>
    <div class="gap8"><button class="btn bsm" onclick="saveNews()">Spara</button><button class="bg bsm" onclick="toggleAnwf()">Avbryt</button></div>
  </div>
  <div id="newsList">${renderNews(s)}</div>
</div>

<div class="tc${activeTab==='checklist'?' active':''}" id="tab-checklist">
  <div class="check-intro"><strong>Pre-trade checklist f√∂r ${s.name}</strong><br>G√• igenom dessa punkter innan du l√§gger en order hos Avanza. F√•nga upp om du agerar p√• k√§nslor snarare √§n fundamenta.</div>
  <div class="check-score">
    <div class="score-circle"><div class="score-num" id="scoreNum">0</div><div class="score-denom">/ ${CHECKLIST.length}</div></div>
    <div class="score-text"><div class="score-title" id="scoreTitle">Inte p√•b√∂rjad</div><div class="score-sub" id="scoreSub">G√• igenom checklistan innan du handlar</div><div class="score-bar"><div class="score-fill" id="scoreFill" style="width:0%"></div></div></div>
  </div>
  ${['Grundtes','K√§nslor','Analys','Beslut'].map(sec=>`<div class="check-section"><div class="check-section-title">${sec}</div>${CHECKLIST.filter(c=>c.section===sec).map(c=>`<div class="check-item${(s.checks||{})[c.id]?' checked':''}" id="ci-${c.id}" onclick="toggleCheck('${c.id}')"><div class="check-box"><span class="check-tick">‚úì</span></div><div class="check-text"><div class="check-label">${c.label}</div><div class="check-desc">${c.desc}</div></div></div>`).join('')}</div>`).join('')}
  <div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="bg bsm" onclick="resetChecklist()">√Öterst√§ll checklist</button></div>
</div>

<div class="tc${activeTab==='saljregler'?' active':''}" id="tab-saljregler">
  <div class="sell-intro"><strong>Skriv dina s√§ljregler nu ‚Äî inte n√§r kursen faller.</strong><br>Definiera exit-kriterierna n√§r du √§r lugn och rationell, inte i stundens hetta.</div>
  <div class="sell-section"><div class="sell-section-h"><span class="sell-section-icon">üí•</span><span class="sell-section-label red">Tes-brottspunkter ‚Äî Jag s√§ljer om...</span></div><textarea class="sell-ta" id="sell-thesis" placeholder="Konkreta h√§ndelser som bryter din grundtes. Inte kursr√∂relser ‚Äî fundamenta.&#10;&#10;Ex:&#10;‚Ä¢ Om bolaget f√∂rlorar sin prim√§rmarknad&#10;‚Ä¢ Om marginalen faller under X% tv√• kvartal i rad">${s.sell_thesis||''}</textarea><div class="sell-footer"><span class="saved-hint" id="sell-thesis-hint">Osparad</span><button class="btn bsm" onclick="saveSell('thesis')">Spara</button></div></div>
  <div class="sell-section"><div class="sell-section-h"><span class="sell-section-icon">‚è±Ô∏è</span><span class="sell-section-label gold">Tidsgr√§ns ‚Äî Tesen ska visa sig inom...</span></div><textarea class="sell-ta" id="sell-time" placeholder="N√§r ska du ha sett resultaten du f√∂rv√§ntar dig?&#10;&#10;Ex:&#10;‚Ä¢ Q3 2026: Marginalen ska b√∂rja f√∂rb√§ttras&#10;‚Ä¢ Senast H1 2027 omv√§rderar jag innehavet">${s.sell_time||''}</textarea><div class="sell-footer"><span class="saved-hint" id="sell-time-hint">Osparad</span><button class="btn bsm" onclick="saveSell('time')">Spara</button></div></div>
  <div class="sell-section"><div class="sell-section-h"><span class="sell-section-icon">üìä</span><span class="sell-section-label blue">Positionsgr√§ns ‚Äî Max exponering</span></div><textarea class="sell-ta" id="sell-size" placeholder="Hur stor andel av portf√∂ljen f√•r detta bolag bli?&#10;&#10;Ex:&#10;‚Ä¢ Max 15% av portf√∂ljen&#10;‚Ä¢ Om innehavet v√§xer till >20% trimmar jag tillbaka">${s.sell_size||''}</textarea><div class="sell-footer"><span class="saved-hint" id="sell-size-hint">Osparad</span><button class="btn bsm" onclick="saveSell('size')">Spara</button></div></div>
</div>

<div class="tc${activeTab==='bullbear'?' active':''}" id="tab-bullbear">
  <div class="bbg">
    <div class="bbc bull"><div class="bbh"><span class="bbicon">‚Üë</span><span class="bblabel">Bull-case</span></div><div class="bbbody"><textarea class="bbta" id="bull-ta" placeholder="Katalysatorer? Varf√∂r stiger kursen? Max uppsida?">${s.bull||''}</textarea><button class="btn bsm" onclick="saveBB('bull')">Spara</button></div></div>
    <div class="bbc bear"><div class="bbh"><span class="bbicon">‚Üì</span><span class="bblabel">Bear-case</span></div><div class="bbbody"><textarea class="bbta" id="bear-ta" placeholder="Risker? Vad kan g√• fel? Max nedsida?">${s.bear||''}</textarea><button class="btn bsm" onclick="saveBB('bear')">Spara</button></div></div>
  </div>
</div>

<div class="tc${activeTab==='k√§llor'?' active':''}" id="tab-k√§llor">
  <div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:10px">L√§nkar, rapporter & k√§llor</div>
  <textarea class="sources-ta" id="sources-ta" placeholder="Klistra in l√§nkar till rapporter, analytikerkommentarer...">${s.sources||''}</textarea>
  <div style="margin-top:10px"><button class="btn bsm" onclick="saveSources()">Spara</button></div>
</div>`;
  updateCheckScore();
  // Auto-fetch description/CEO from B√∂rsdata if connected and not yet loaded
  if(s.bdConnected&&s.bdInsId&&borsdataKey&&(!s.description||!s.ceo)){
    fetchBdDetails(s.id);
  }
}

async function fetchBdDetails(stockId){
  const s=stocks.find(x=>x.id===stockId);
  if(!s||!borsdataKey||!s.bdInsId)return;
  try{
    const r=await fetch(`${BORSDATA_BASE}/instruments/${s.bdInsId}/description?authKey=${borsdataKey}`);
    const d=await r.json();
    let updated=false;
    // Description
    const desc=d.description||d.Description||d.text||d.Text||'';
    if(desc&&!s.description){s.description=desc;updated=true;}
    // CEO ‚Äî B√∂rsdata returns management info in company details
    const ceo=d.ceo||d.Ceo||d.CEO||d.director||d.Director||'';
    if(ceo&&!s.ceo){s.ceo=ceo;updated=true;}
    if(updated){
      save();
      // Update just the hero desc without full re-render
      const descEl=document.getElementById('hero-desc');
      if(descEl&&s.description){
        descEl.innerHTML=`<div class="hdesc" style="margin-top:10px">${s.description}</div>`
          +(s.ceo?`<div class="hceo">VD: <span class="hceo-name">${s.ceo}</span></div>`:'');
      }
    }
  }catch(e){}
}

// ‚ïê‚ïê RISKS ‚ïê‚ïê
function renderRisks(s){
  const risks=s.risks||[];
  if(!risks.length) return `<div class="risk-empty">Inga risker identifierade √§nnu</div>`;
  return risks.map((r,i)=>`
    <div class="risk-item" id="risk-item-${i}">
      <div class="risk-dot"></div>
      <textarea class="risk-text" rows="1" onchange="updateRisk(${i},this.value)" oninput="autoResize(this)">${r}</textarea>
      <span class="risk-del" onclick="deleteRisk(${i})">‚úï</span>
    </div>`).join('');
}
function addRisk(){
  const s=stocks.find(x=>x.id===activeId);if(!s)return;
  const inp=document.getElementById('risk-input');
  const val=inp.value.trim();if(!val)return;
  if(!s.risks)s.risks=[];
  s.risks.push(val);
  save();
  inp.value='';
  document.getElementById('risksList').innerHTML=renderRisks(s);
  document.getElementById('risk-input').focus();
  // Update count
  const lbl=document.querySelector('.risk-label span:last-child');
  if(lbl)lbl.textContent=s.risks.length+' identifierade';
}
function riskKeydown(e){if(e.key==='Enter'){e.preventDefault();addRisk();}}
function updateRisk(i,val){
  const s=stocks.find(x=>x.id===activeId);if(!s||!s.risks)return;
  s.risks[i]=val;save();
}
function deleteRisk(i){
  const s=stocks.find(x=>x.id===activeId);if(!s||!s.risks)return;
  s.risks.splice(i,1);save();
  document.getElementById('risksList').innerHTML=renderRisks(s);
  const lbl=document.querySelector('.risk-label span:last-child');
  if(lbl)lbl.textContent=s.risks.length+' identifierade';
}
function autoResize(ta){ta.style.height='auto';ta.style.height=ta.scrollHeight+'px';}

// ‚ïê‚ïê CATALYSTS ‚ïê‚ïê
const CAT_TYPES={
  rapport:{label:'Rapport',emoji:'üìä'},
  rantebesked:{label:'R√§ntebesked',emoji:'üè¶'},
  utdelning:{label:'Utdelning',emoji:'üí∞'},
  produkt:{label:'Produkt/lansering',emoji:'üöÄ'},
  makro:{label:'Makroh√§ndelse',emoji:'üåç'},
  bolagsstamma:{label:'Bolagsst√§mma',emoji:'üó≥Ô∏è'},
  ovrigt:{label:'√ñvrigt',emoji:'üìå'},
};
function renderCatalysts(s){
  const cats=(s.catalysts||[]).slice().sort((a,b)=>new Date(a.date)-new Date(b.date));
  if(!cats.length) return`<div class="cat-empty">Inga h√§ndelser tillagda ‚Äî tryck + f√∂r att l√§gga till rapport, r√§ntebesked, utdelning m.m.</div>`;
  const today=new Date();today.setHours(0,0,0,0);
  return cats.map((c,i)=>{
    const d=new Date(c.date);
    const diff=Math.round((d-today)/(1000*60*60*24));
    const isPast=diff<0;
    let daysLabel='',daysClass='';
    if(isPast){daysLabel=`${Math.abs(diff)}d sedan`;daysClass='past';}
    else if(diff===0){daysLabel='Idag';daysClass='soon';}
    else if(diff<=7){daysLabel=`Om ${diff}d`;daysClass='soon';}
    else if(diff<=30){daysLabel=`Om ${diff}d`;daysClass='upcoming';}
    else{daysLabel=`Om ${diff}d`;daysClass='future';}
    const t=CAT_TYPES[c.type]||CAT_TYPES.ovrigt;
    return`<div class="cat-item" style="${isPast?'opacity:0.5':''}">
      <div class="cat-type-dot" data-t="${c.type}"></div>
      <div class="cat-date-col">
        <div class="cat-date${isPast?' past':''}">${d.toLocaleDateString('sv-SE',{day:'numeric',month:'short'})}</div>
        <div class="cat-days ${daysClass}">${daysLabel}</div>
      </div>
      <div class="cat-content">
        <div class="cat-name">${t.emoji} ${c.name}</div>
        ${c.note?`<div class="cat-note">${c.note}</div>`:''}
      </div>
      <span class="cat-del" onclick="deleteCatalyst(${i})">‚úï</span>
    </div>`;
  }).join('');
}
function toggleCatForm(){
  const f=document.getElementById('catAddForm');
  f.classList.toggle('open');
  if(f.classList.contains('open')){
    // Default date to today
    const d=new Date();
    document.getElementById('cat-date').value=d.toISOString().split('T')[0];
    document.getElementById('cat-name').focus();
  }
}
function saveCatalyst(){
  const s=stocks.find(x=>x.id===activeId);if(!s)return;
  const date=document.getElementById('cat-date').value;
  const name=document.getElementById('cat-name').value.trim();
  if(!date||!name)return;
  if(!s.catalysts)s.catalysts=[];
  s.catalysts.push({
    id:'c'+Date.now(),
    date,name,
    type:document.getElementById('cat-type').value,
    note:document.getElementById('cat-note').value.trim()
  });
  save();
  document.getElementById('catBody').innerHTML=renderCatalysts(s);
  document.getElementById('cat-name').value='';
  document.getElementById('cat-note').value='';
  document.getElementById('catAddForm').classList.remove('open');
}
function deleteCatalyst(i){
  const s=stocks.find(x=>x.id===activeId);if(!s||!s.catalysts)return;
  // Re-sort to match render order before deleting
  s.catalysts.sort((a,b)=>new Date(a.date)-new Date(b.date));
  s.catalysts.splice(i,1);
  save();
  document.getElementById('catBody').innerHTML=renderCatalysts(s);
}

function renderTags(s){return(s.tags||[]).map(t=>`<div class="tag">${t}<span class="tagx" onclick="removeTag('${t}')">√ó</span></div>`).join('')+`<div class="tag tagadd" onclick="startTagInput()">+ Tagg</div>`;}
function removeTag(t){const s=stocks.find(x=>x.id===activeId);if(s){s.tags=(s.tags||[]).filter(x=>x!==t);save();document.getElementById('stockTags').innerHTML=renderTags(s);}}
function startTagInput(){const s=stocks.find(x=>x.id===activeId);if(!s)return;const c=document.getElementById('stockTags'),a=c.querySelector('.tagadd'),i=document.createElement('input');i.className='taginput';i.placeholder='Ny tagg...';a.replaceWith(i);i.focus();i.onkeydown=e=>{if(e.key==='Enter'||e.key===','){e.preventDefault();const v=i.value.trim();if(v){if(!s.tags)s.tags=[];if(!s.tags.includes(v))s.tags.push(v);save();}c.innerHTML=renderTags(s);}if(e.key==='Escape')c.innerHTML=renderTags(s);};i.onblur=()=>setTimeout(()=>{if(document.contains(i))c.innerHTML=renderTags(s);},200);}

function swTab(tab,el){activeTab=tab;document.querySelectorAll('.stab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tc').forEach(c=>c.classList.remove('active'));if(el)el.classList.add('active');const tc=document.getElementById('tab-'+tab);if(tc)tc.classList.add('active');if(tab==='checklist')updateCheckScore();}

function saveThesis(){const s=stocks.find(x=>x.id===activeId);if(!s)return;s.thesis=document.getElementById('thesis-ta').value;save();renderSidebar();const h=document.getElementById('thesis-hint');if(h){h.textContent='Sparad ‚úì';h.classList.add('ok');setTimeout(()=>{h.textContent='Spara f√∂r att logga en ny version';h.classList.remove('ok');},2000);}}
function saveRevision(){const s=stocks.find(x=>x.id===activeId);if(!s)return;const text=document.getElementById('thesis-ta').value.trim();if(!text)return;if(!s.revisions)s.revisions=[];s.revisions.push({date:new Date().toLocaleDateString('sv-SE',{day:'numeric',month:'long',year:'numeric'}),text});s.thesis=text;save();renderStock();}

function renderNotes(s){const n=(s.notes||[]).filter(x=>noteFilter==='all'||x.cat===noteFilter);if(!n.length)return`<div style="text-align:center;padding:24px;color:var(--muted);font-size:11px">Inga anteckningar ‚Äî tryck "+ Ny anteckning"</div>`;return n.map(x=>`<div class="ncard"><div class="ncard-h" onclick="toggleNcard(this)"><div class="ndot" data-c="${x.cat}"></div><div class="ncard-title">${x.title}</div><div class="ncard-meta"><span style="color:${CC[x.cat]||'var(--muted2)'}">${CL[x.cat]||x.cat}</span><span>${x.date||''}</span><span>‚ñæ</span></div></div><div class="ncard-body"><textarea class="ncard-ta" onchange="updNote('${x.id}',this.value)">${x.body}</textarea><div class="ncard-actions"><button class="btn bsm" onclick="saveNoteEdit(this)">Spara</button><button class="bg bsm" onclick="delNote('${x.id}')">Ta bort</button></div></div></div>`).join('');}
function toggleAnf(){const f=document.getElementById('addNoteForm');f.classList.toggle('open');if(f.classList.contains('open'))document.getElementById('note-title').focus();}
function saveNote(){const s=stocks.find(x=>x.id===activeId);if(!s)return;const t=document.getElementById('note-title').value.trim(),b=document.getElementById('note-body').value.trim();if(!t&&!b)return;if(!s.notes)s.notes=[];s.notes.unshift({id:'n'+Date.now(),title:t||'Utan titel',body:b,cat:document.getElementById('note-cat').value,date:new Date().toLocaleDateString('sv-SE')});save();document.getElementById('note-title').value='';document.getElementById('note-body').value='';document.getElementById('addNoteForm').classList.remove('open');document.getElementById('notesList').innerHTML=renderNotes(stocks.find(x=>x.id===activeId));}
function toggleNcard(el){const b=el.nextElementSibling;b.classList.toggle('open');el.querySelector('span:last-child').textContent=b.classList.contains('open')?'‚ñ¥':'‚ñæ';}
function filterN(cat,el){noteFilter=cat;document.querySelectorAll('.nf').forEach(f=>f.classList.remove('active'));el.classList.add('active');const s=stocks.find(x=>x.id===activeId);if(s)document.getElementById('notesList').innerHTML=renderNotes(s);}
function updNote(id,val){const s=stocks.find(x=>x.id===activeId);if(!s)return;const n=(s.notes||[]).find(x=>x.id===id);if(n)n.body=val;}
function saveNoteEdit(btn){save();btn.textContent='Sparad ‚úì';setTimeout(()=>{btn.textContent='Spara';},1500);}
function delNote(id){const s=stocks.find(x=>x.id===activeId);if(!s)return;s.notes=(s.notes||[]).filter(n=>n.id!==id);save();document.getElementById('notesList').innerHTML=renderNotes(s);}

function renderNews(s){const n=s.news||[];if(!n.length)return`<div class="news-empty"><div style="font-size:26px;margin-bottom:8px">üì∞</div><div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">Inga nyheter sparade</div></div>`;return n.map(x=>`<div class="nwcard"><div class="nwc-top"><div class="nwc-title">${x.title}</div><div class="nbadge ${x.impact==='h'?'nbh':x.impact==='m'?'nbm':'nbl'}">${x.impact==='h'?'H√ñG':x.impact==='m'?'MEDEL':'POSITIV'}</div></div><div class="nwc-body">${x.body}</div><div class="nwc-foot"><div class="nwc-tags">${(x.tags||[]).map(t=>`<span class="nwtag">${t}</span>`).join('')}</div><div style="display:flex;align-items:center"><span class="nwc-meta">${x.date||''}</span><span class="nwdel" onclick="delNews('${x.id}')">‚úï</span></div></div>${x.url?`<a class="nwlink" href="${x.url}" target="_blank">‚Üó Originalk√§lla</a>`:''}</div>`).join('');}
function toggleAnwf(){const f=document.getElementById('addNewsForm');f.classList.toggle('open');if(f.classList.contains('open'))document.getElementById('nw-title').focus();}
function saveNews(){const s=stocks.find(x=>x.id===activeId);if(!s)return;const t=document.getElementById('nw-title').value.trim();if(!t)return;if(!s.news)s.news=[];s.news.unshift({id:'nw'+Date.now(),title:t,body:document.getElementById('nw-body').value,impact:document.getElementById('nw-impact').value,url:document.getElementById('nw-url').value,tags:document.getElementById('nw-tags').value.split(',').map(x=>x.trim()).filter(Boolean),date:new Date().toLocaleDateString('sv-SE')});save();['nw-title','nw-body','nw-url','nw-tags'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});document.getElementById('addNewsForm').classList.remove('open');document.getElementById('newsList').innerHTML=renderNews(stocks.find(x=>x.id===activeId));}
function delNews(id){const s=stocks.find(x=>x.id===activeId);if(!s)return;s.news=(s.news||[]).filter(n=>n.id!==id);save();document.getElementById('newsList').innerHTML=renderNews(s);}

function toggleCheck(id){const s=stocks.find(x=>x.id===activeId);if(!s)return;if(!s.checks)s.checks={};s.checks[id]=!s.checks[id];save();const el=document.getElementById('ci-'+id);if(el)el.classList.toggle('checked',s.checks[id]);updateCheckScore();}
function updateCheckScore(){const s=stocks.find(x=>x.id===activeId);if(!s)return;const checked=Object.values(s.checks||{}).filter(Boolean).length,total=CHECKLIST.length,pct=Math.round(checked/total*100);const ne=document.getElementById('scoreNum'),te=document.getElementById('scoreTitle'),se=document.getElementById('scoreSub'),fe=document.getElementById('scoreFill');if(!ne)return;ne.textContent=checked;fe.style.width=pct+'%';if(pct===0){ne.style.color='var(--muted2)';te.textContent='Inte p√•b√∂rjad';se.textContent='G√• igenom checklistan innan du handlar';}else if(pct<100){ne.style.color='var(--gold)';te.textContent='P√•g√•r...';se.textContent=`${checked} av ${total} punkter avklarade`;}else{ne.style.color='var(--green)';te.textContent='Checklistan klar ‚úì';se.textContent='Du kan nu l√§gga din order med gott samvete';}}
function resetChecklist(){const s=stocks.find(x=>x.id===activeId);if(!s)return;s.checks={};save();CHECKLIST.forEach(c=>{const el=document.getElementById('ci-'+c.id);if(el)el.classList.remove('checked');});updateCheckScore();}

function saveSell(key){const s=stocks.find(x=>x.id===activeId);if(!s)return;s['sell_'+key]=document.getElementById('sell-'+key).value;save();const h=document.getElementById('sell-'+key+'-hint');if(h){h.textContent='Sparad ‚úì';h.classList.add('ok');setTimeout(()=>{h.textContent='Osparad';h.classList.remove('ok');},2000);}}
function saveBB(k){const s=stocks.find(x=>x.id===activeId);if(!s)return;s[k]=document.getElementById(k+'-ta').value;save();const btn=event.target;btn.textContent='Sparad ‚úì';setTimeout(()=>{btn.textContent='Spara';},1500);}
function saveSources(){const s=stocks.find(x=>x.id===activeId);if(!s)return;s.sources=document.getElementById('sources-ta').value;save();const btn=event.target;btn.textContent='Sparad ‚úì';setTimeout(()=>{btn.textContent='Spara';},1500);}
function editGav(){
  const s=stocks.find(x=>x.id===activeId);if(!s)return;
  const v=prompt(`GAV (anskaffningsv√§rde) f√∂r ${s.name}:\nAnge din genomsnittliga anskaffningskurs:`,s.gav||'');
  if(v===null)return;
  s.gav=v.trim();
  save();
  renderStock();
}

async function fetchClosePrice(){
  const s=stocks.find(x=>x.id===activeId);if(!s)return;
  const btn=event.target;
  btn.textContent='H√§mtar...';btn.disabled=true;

  // Try B√∂rsdata if connected
  if(borsdataKey&&s.bdInsId){
    try{
      const r=await fetch(`${BORSDATA_BASE}/instruments/${s.bdInsId}/stockprices/last?authKey=${borsdataKey}`);
      const d=await r.json();
      const p=d.stockPricesList?.[0];
      if(p){
        s.closePrice=p.c?.toFixed(2)||p.o?.toFixed(2)||'';
        s.closePriceDate=p.d||'';
        save();renderStock();return;
      }
    }catch(e){}
  }

  // Manual fallback
  btn.textContent='‚ü≥ H√§mta kurs';btn.disabled=false;
  const v=prompt(`Ange g√•rdagens st√§ngningskurs f√∂r ${s.name}:`,s.closePrice||s.price||'');
  if(v===null)return;
  s.closePrice=v.trim();
  s.closePriceDate=(() => {
    const d=new Date();d.setDate(d.getDate()-1);
    // Skip to friday if weekend
    if(d.getDay()===0)d.setDate(d.getDate()-2);
    if(d.getDay()===6)d.setDate(d.getDate()-1);
    return d.toLocaleDateString('sv-SE');
  })();
  save();renderSidebar();renderStock();
}

// Legacy compat
function editPrice(){fetchClosePrice();}

function connectApi(){const k=document.getElementById('apiKeyInput')?.value?.trim();if(!k)return;saveApiKey(k);renderStock();}
function handleChatKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat();}}
async function sendChat(){
  if(!apiKey)return;
  const input=document.getElementById('chatInput');
  const msg=input?.value?.trim();if(!msg)return;
  input.value='';
  const s=stocks.find(x=>x.id===activeId);if(!s)return;
  const msgs=document.getElementById('chatMessages');
  msgs.innerHTML+=`<div class="msg msg-user"><div class="msg-name">Du</div><div class="msg-bubble">${msg}</div></div>`;
  msgs.innerHTML+=`<div class="msg msg-ai" id="typing-indicator"><div class="msg-name">Claude</div><div class="msg-bubble"><div class="typing"><span></span><span></span><span></span></div></div></div>`;
  msgs.scrollTop=msgs.scrollHeight;
  const context=`Du √§r ett AI-bollplank f√∂r en investerare. Information om bolaget:\n\nBolag: ${s.name} (${s.ticker})\nKurs: ${s.price||'ok√§nd'}\n\nGRUNDTES:\n${s.thesis||'(ingen grundtes)'}\n\nBULL-CASE:\n${s.bull||'(inget)'}\n\nBEAR-CASE:\n${s.bear||'(inget)'}\n\nS√ÑLJREGLER:\n${s.sell_thesis||'(inga)'}\n\nRISKER:\n${(s.risks||[]).map((r,i)=>`${i+1}. ${r}`).join('\n')||'(inga definierade)'}\n\nKATALYSATORER:\n${(s.catalysts||[]).sort((a,b)=>new Date(a.date)-new Date(b.date)).map(c=>`${c.date}: ${c.name}${c.note?' ‚Äî '+c.note:''}`).join('\n')||'(inga)'}\n\nANTECKNINGAR:\n${(s.notes||[]).map(n=>`[${CL[n.cat]}] ${n.title}: ${n.body}`).join('\n')||'(inga)'}\n\nSvara p√• svenska. Var konkret och analytisk. Utmana investerarens antaganden konstruktivt. H√•ll svaren till 3-5 meningar om inget annat bes om.`;
  chatHistory.push({role:'user',content:msg});
  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:600,system:context,messages:chatHistory})});
    const data=await resp.json();
    const reply=data.content?.[0]?.text||'N√•got gick fel. Kontrollera din API-nyckel.';
    chatHistory.push({role:'assistant',content:reply});
    const t=document.getElementById('typing-indicator');
    if(t)t.outerHTML=`<div class="msg msg-ai"><div class="msg-name">Claude</div><div class="msg-bubble">${reply.replace(/\n/g,'<br>')}</div></div>`;
  }catch(e){const t=document.getElementById('typing-indicator');if(t)t.outerHTML=`<div class="msg msg-ai"><div class="msg-name">Claude</div><div class="msg-bubble" style="color:var(--red)">Fel: Kontrollera API-nyckeln.</div></div>`;}
  msgs.scrollTop=msgs.scrollHeight;
}

function genOnepager(){
  if(!stocks.length){document.getElementById('opContent').innerHTML=`<div class="news-empty"><div style="font-size:28px;margin-bottom:8px">‚óé</div><div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">L√§gg till bolag f√∂rst</div></div>`;return;}
  document.getElementById('opBadge').textContent='Genererar...';
  document.getElementById('opContent').innerHTML=`<div style="text-align:center;padding:60px;color:var(--muted)"><div style="font-size:24px;display:inline-block;animation:spin 1s linear infinite">‚óå</div><br><br>Analyserar ${stocks.length} bolag...</div>`;
  setTimeout(()=>{
    const now=new Date();
    document.getElementById('opBadge').textContent=`Genererad ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')} ¬∑ ${stocks.length} bolag bevakade`;
    const items=[{t:'Fed h√•ller r√§ntan ‚Äî splittrad syn p√• s√§nkningstakt 2026',b:'Mer restriktiv ton d√§mpar riskaptit och p√•verkar v√§rdering av tillv√§xtbolag globalt.',i:'h',tags:['Makro','Fed','R√§nta']},{t:'Stark AI-infrastrukturefterfr√•gan driver halvledarsektorn',b:'Hyperscalers √∂kar datacenterinvesteringar. Positivt f√∂r bolag med AI-exponering.',i:'l',tags:['AI','Tech']},{t:'Riksbanken √∂ppnar f√∂r r√§ntes√§nkning Q2',b:'Vice riksbankschefen signalerar att inflationsdatan m√∂jligg√∂r en s√§nkning under v√•ren.',i:'m',tags:['Riksbanken','Sverige']}];
    document.getElementById('opContent').innerHTML=items.map(n=>`<div class="nwcard"><div class="nwc-top"><div class="nwc-title">${n.t}</div><div class="nbadge ${n.i==='h'?'nbh':n.i==='m'?'nbm':'nbl'}">${n.i==='h'?'H√ñG P√ÖVERKAN':n.i==='m'?'MEDEL':'POSITIV SIGNAL'}</div></div><div class="nwc-body">${n.b}</div><div class="nwc-foot"><div class="nwc-tags">${n.tags.map(t=>`<span class="nwtag">${t}</span>`).join('')}${stocks.slice(0,2).map(s=>`<span class="nwtag">${s.ticker}</span>`).join('')}</div><span class="nwc-meta">${now.toLocaleDateString('sv-SE')}</span></div></div>`).join('');
  },1600);
}

// ‚ïê‚ïê B√ñRSDATA API LAYER ‚ïê‚ïê
// Alla API-anrop g√•r igenom dessa funktioner.
// N√§r du har din B√∂rsdata API-nyckel, klistra in den i inst√§llningarna.
// Appen v√§ljer automatiskt r√§tt endpoint baserat p√• om nyckeln finns.

const BORSDATA_BASE = 'https://apiservice.borsdata.se/v1';
let borsdataKey = '';
let selectedCompany = null;
let searchTimer = null;

// B√∂rsdata instrument cache (laddas en g√•ng)
let bdInstruments = null;

async function loadKeys(){
  try{const r=localStorage.getItem('pv5-bdkey');if(r){borsdataKey=r;const el=document.getElementById('m-bd-key');if(el)el.value=borsdataKey;}}catch(e){}
}
async function saveBorsdataKey(k){
  borsdataKey=k.trim();
  try{localStorage.setItem('pv5-bdkey',borsdataKey);}catch(e){}
  // Reload instruments cache when key changes
  bdInstruments=null;
  updateModalKeyStatus();
}

function updateModalKeyStatus(){
  const el=document.getElementById('modal-key-status');
  if(!el)return;
  if(borsdataKey){
    el.textContent='‚úì B√∂rsdata-nyckel aktiv';
    el.style.color='var(--green)';
  } else {
    el.textContent='Ingen nyckel ‚Äî s√∂ker med fallback';
    el.style.color='var(--muted)';
  }
}

// ‚îÄ‚îÄ B√∂rsdata: h√§mta alla instrument (cachat) ‚îÄ‚îÄ
async function bdGetInstruments(){
  if(bdInstruments) return bdInstruments;
  if(!borsdataKey) return null;
  try{
    const r=await fetch(`${BORSDATA_BASE}/instruments?authKey=${borsdataKey}`);
    const d=await r.json();
    bdInstruments=d.instruments||[];
    return bdInstruments;
  }catch(e){return null;}
}

// ‚îÄ‚îÄ B√∂rsdata: h√§mta detaljer f√∂r ett instrument ‚îÄ‚îÄ
async function bdGetDetails(insId){
  if(!borsdataKey||!insId) return null;
  try{
    const r=await fetch(`${BORSDATA_BASE}/instruments/${insId}/description?authKey=${borsdataKey}`);
    return await r.json();
  }catch(e){return null;}
}

// ‚îÄ‚îÄ B√∂rsdata: h√§mta senaste kurs ‚îÄ‚îÄ
async function bdGetLastPrice(insId){
  if(!borsdataKey||!insId) return null;
  try{
    const r=await fetch(`${BORSDATA_BASE}/instruments/${insId}/stockprices/last?authKey=${borsdataKey}`);
    const d=await r.json();
    return d.stockPricesList?.[0]||null;
  }catch(e){return null;}
}

// ‚îÄ‚îÄ B√∂rsdata: s√∂k bland instrument ‚îÄ‚îÄ
async function bdSearch(query){
  const instruments=await bdGetInstruments();
  if(!instruments) return null;
  const q=query.toLowerCase();
  return instruments
    .filter(i=>(i.name||'').toLowerCase().includes(q)||(i.ticker||'').toLowerCase().includes(q))
    .slice(0,12)
    .map(i=>({
      insId:i.insId,
      name:i.name,
      ticker:i.ticker,
      exchange:i.exchange||i.market||'',
      country:i.country||'',
      currency:i.currency||'SEK',
      sector:i.sector||'',
      branch:i.branch||i.industry||'',
      source:'borsdata'
    }));
}

// ‚îÄ‚îÄ Fallback: √∂ppen s√∂kning utan nyckel ‚îÄ‚îÄ
// Statisk lista med de mest s√∂kta bolagen som fallback
const FALLBACK_STOCKS = [
  {name:'Apple Inc',ticker:'AAPL',exchange:'NASDAQ',country:'US',currency:'USD',sector:'Technology',branch:'Consumer Electronics',source:'fallback'},
  {name:'Microsoft Corporation',ticker:'MSFT',exchange:'NASDAQ',country:'US',currency:'USD',sector:'Technology',branch:'Software',source:'fallback'},
  {name:'Amazon.com Inc',ticker:'AMZN',exchange:'NASDAQ',country:'US',currency:'USD',sector:'Consumer Cyclical',branch:'Internet Retail',source:'fallback'},
  {name:'NVIDIA Corporation',ticker:'NVDA',exchange:'NASDAQ',country:'US',currency:'USD',sector:'Technology',branch:'Semiconductors',source:'fallback'},
  {name:'Alphabet Inc (Google)',ticker:'GOOGL',exchange:'NASDAQ',country:'US',currency:'USD',sector:'Technology',branch:'Internet',source:'fallback'},
  {name:'Meta Platforms Inc',ticker:'META',exchange:'NASDAQ',country:'US',currency:'USD',sector:'Technology',branch:'Social Media',source:'fallback'},
  {name:'Tesla Inc',ticker:'TSLA',exchange:'NASDAQ',country:'US',currency:'USD',sector:'Consumer Cyclical',branch:'Electric Vehicles',source:'fallback'},
  {name:'Berkshire Hathaway',ticker:'BRK.B',exchange:'NYSE',country:'US',currency:'USD',sector:'Financial',branch:'Insurance',source:'fallback'},
  {name:'JPMorgan Chase',ticker:'JPM',exchange:'NYSE',country:'US',currency:'USD',sector:'Financial',branch:'Banking',source:'fallback'},
  {name:'Visa Inc',ticker:'V',exchange:'NYSE',country:'US',currency:'USD',sector:'Financial',branch:'Payments',source:'fallback'},
  {name:'Investor AB',ticker:'INVE B',exchange:'STO',country:'SE',currency:'SEK',sector:'Financial',branch:'Investment Company',source:'fallback'},
  {name:'Ericsson',ticker:'ERIC B',exchange:'STO',country:'SE',currency:'SEK',sector:'Technology',branch:'Telecom Equipment',source:'fallback'},
  {name:'Volvo AB',ticker:'VOLV B',exchange:'STO',country:'SE',currency:'SEK',sector:'Industrials',branch:'Trucks',source:'fallback'},
  {name:'Atlas Copco',ticker:'ATCO A',exchange:'STO',country:'SE',currency:'SEK',sector:'Industrials',branch:'Industrial Machinery',source:'fallback'},
  {name:'Hexagon AB',ticker:'HEXA B',exchange:'STO',country:'SE',currency:'SEK',sector:'Technology',branch:'Measurement Tech',source:'fallback'},
  {name:'Handelsbanken',ticker:'SHB A',exchange:'STO',country:'SE',currency:'SEK',sector:'Financial',branch:'Banking',source:'fallback'},
  {name:'SEB AB',ticker:'SEB A',exchange:'STO',country:'SE',currency:'SEK',sector:'Financial',branch:'Banking',source:'fallback'},
  {name:'Swedbank',ticker:'SWED A',exchange:'STO',country:'SE',currency:'SEK',sector:'Financial',branch:'Banking',source:'fallback'},
  {name:'Nordea Bank',ticker:'NDA SE',exchange:'STO',country:'SE',currency:'SEK',sector:'Financial',branch:'Banking',source:'fallback'},
  {name:'H&M',ticker:'HM B',exchange:'STO',country:'SE',currency:'SEK',sector:'Consumer',branch:'Retail',source:'fallback'},
  {name:'Essity AB',ticker:'ESSITY B',exchange:'STO',country:'SE',currency:'SEK',sector:'Consumer',branch:'Hygiene',source:'fallback'},
  {name:'Sandvik AB',ticker:'SAND',exchange:'STO',country:'SE',currency:'SEK',sector:'Industrials',branch:'Mining Equipment',source:'fallback'},
  {name:'SKF AB',ticker:'SKF B',exchange:'STO',country:'SE',currency:'SEK',sector:'Industrials',branch:'Bearings',source:'fallback'},
  {name:'AstraZeneca',ticker:'AZN',exchange:'LSE',country:'GB',currency:'GBP',sector:'Healthcare',branch:'Pharmaceuticals',source:'fallback'},
  {name:'LVMH',ticker:'MC',exchange:'EPA',country:'FR',currency:'EUR',sector:'Consumer',branch:'Luxury Goods',source:'fallback'},
  {name:'ASML Holding',ticker:'ASML',exchange:'NASDAQ',country:'NL',currency:'EUR',sector:'Technology',branch:'Semiconductor Equipment',source:'fallback'},
];

function fallbackSearch(query){
  const q=query.toLowerCase();
  return FALLBACK_STOCKS.filter(s=>
    s.name.toLowerCase().includes(q)||
    s.ticker.toLowerCase().includes(q)||
    s.sector.toLowerCase().includes(q)
  ).slice(0,8);
}

// ‚îÄ‚îÄ SEARCH ORCHESTRATOR ‚îÄ‚îÄ
function searchCompany(query){
  clearTimeout(searchTimer);
  const q=query.trim();
  const res=document.getElementById('search-results');
  if(q.length<2){res.style.display='none';return;}
  document.getElementById('search-spinner').style.display='block';
  searchTimer=setTimeout(()=>doSearch(q),350);
}

async function doSearch(q){
  const res=document.getElementById('search-results');
  const spinner=document.getElementById('search-spinner');
  try{
    let results=[];
    let sourceLabel='';
    if(borsdataKey){
      // Try B√∂rsdata first
      const bdResults=await bdSearch(q);
      if(bdResults&&bdResults.length){
        results=bdResults;
        sourceLabel='B√∂rsdata';
      }
    }
    if(!results.length){
      // Fallback to built-in list
      results=fallbackSearch(q);
      sourceLabel='Inbyggd lista';
    }
    spinner.style.display='none';
    if(!results.length){
      res.style.display='block';
      res.innerHTML=`<div style="padding:16px;text-align:center;font-size:12px;color:var(--muted)">
        Inga tr√§ffar f√∂r "<strong>${q}</strong>"<br>
        <span style="font-size:11px">Prova en annan stavning, eller l√§gg till manuellt nedan</span>
      </div>`;
      return;
    }
    res.style.display='block';
    res.innerHTML=`<div style="padding:7px 14px;font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);background:var(--s2);border-bottom:1px solid var(--border)">K√ÑLLA: ${sourceLabel} ¬∑ ${results.length} tr√§ffar</div>`+
    results.map(c=>{
      const flag=getFlag(c.exchange,c.country);
      const safeC=encodeURIComponent(JSON.stringify(c));
      return`<div class="search-result-item" onclick="selectCompany(decodeURIComponent('${safeC}'),true)">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <div>
            <div style="font-weight:500;font-size:13px;color:var(--blue-dark)">${flag} ${c.name}</div>
            <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted2);margin-top:2px;display:flex;gap:8px">
              <span>${c.ticker}</span><span>¬∑</span><span>${c.exchange}</span>${c.sector?`<span>¬∑</span><span>${c.sector}</span>`:''}
            </div>
          </div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);text-align:right;flex-shrink:0">${c.currency||''}</div>
        </div>
      </div>`;
    }).join('');
  }catch(e){
    spinner.style.display='none';
    res.style.display='block';
    res.innerHTML=`<div style="padding:16px;text-align:center;font-size:12px;color:var(--red)">S√∂kningen misslyckades</div>`;
  }
}

function getFlag(exchange,country){
  if(country==='SE'||['STO','XSTO','NGM'].some(x=>(exchange||'').toUpperCase().includes(x)))return'üá∏üá™';
  if(country==='US'||['NASDAQ','NYSE','AMEX'].some(x=>(exchange||'').toUpperCase().includes(x)))return'üá∫üá∏';
  if(country==='GB'||['LSE','XLON'].some(x=>(exchange||'').toUpperCase().includes(x)))return'üá¨üáß';
  if(country==='DE'||['XETRA','FRA'].some(x=>(exchange||'').toUpperCase().includes(x)))return'üá©üá™';
  if(country==='FR'||['EPA'].some(x=>(exchange||'').toUpperCase().includes(x)))return'üá´üá∑';
  if(country==='NL'||['AEX'].some(x=>(exchange||'').toUpperCase().includes(x)))return'üá≥üá±';
  return'üåê';
}

function selectCompany(raw, encoded){
  const c = encoded ? JSON.parse(raw) : raw;
  selectedCompany=c;
  document.getElementById('modal-step1').style.display='none';
  document.getElementById('modal-step2').style.display='block';
  const flag=getFlag(c.exchange,c.country);
  document.getElementById('selected-company-card').innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div style="font-size:10px;font-family:'DM Mono',monospace;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.1em">Valt bolag</div>
        <div style="font-family:'Playfair Display',serif;font-size:20px;color:var(--blue-dark)">${flag} ${c.name}</div>
        <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted2);margin-top:5px;display:flex;gap:10px;flex-wrap:wrap">
          <span>${c.ticker}</span><span>¬∑</span><span>${c.exchange}</span>
          ${c.currency?`<span>¬∑</span><span>${c.currency}</span>`:''}
          ${c.sector?`<span>¬∑</span><span style="color:var(--blue-mid)">${c.sector}</span>`:''}
        </div>
        ${c.source==='borsdata'?`<div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--green);margin-top:6px">‚úì Kopplad till B√∂rsdata (ID: ${c.insId})</div>`:
          c.source==='fallback'?`<div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);margin-top:6px">Grunddata ¬∑ L√§gg till B√∂rsdata-nyckel f√∂r fullst√§ndig koppling</div>`:''}
      </div>
      <div style="font-size:26px">${flag}</div>
    </div>`;
  const addBtn=document.getElementById('modal-add-btn');
  addBtn.disabled=false;addBtn.style.opacity='1';addBtn.textContent='L√§gg till bolag';
  setTimeout(()=>document.getElementById('m-price')?.focus(),100);
}

// ‚îÄ‚îÄ MANUAL ADD ‚îÄ‚îÄ
function toggleManualAdd(){
  const f=document.getElementById('manual-add-form');
  f.style.display=f.style.display==='none'?'block':'none';
}
function addManually(){
  const name=document.getElementById('man-name').value.trim();
  const ticker=document.getElementById('man-ticker').value.trim().toUpperCase();
  if(!name||!ticker){alert('Namn och ticker kr√§vs');return;}
  const exch=document.getElementById('man-exch').value;
  const country=exch.includes('STO')||exch.includes('Sverige')?'SE':'US';
  selectCompany({
    name,ticker,
    exchange:exch,
    country,
    currency:country==='SE'?'SEK':'USD',
    sector:'',branch:'',source:'manual',thesis:'',revisions:[],risks:[],catalysts:[],notes:[],news:[],tags:[],checks:{}
  }, false);
}

// ‚ïê‚ïê MODAL OPEN/CLOSE ‚ïê‚ïê
function openModal(){
  selectedCompany=null;
  document.getElementById('moverlay').classList.add('open');
  document.getElementById('modal-step1').style.display='block';
  document.getElementById('modal-step2').style.display='none';
  document.getElementById('search-results').style.display='none';
  document.getElementById('search-results').innerHTML='';
  const addBtn=document.getElementById('modal-add-btn');
  addBtn.disabled=true;addBtn.style.opacity='0.4';addBtn.textContent='V√§lj ett bolag f√∂rst';
  const inp=document.getElementById('m-search');if(inp)inp.value='';
  const price=document.getElementById('m-price');if(price)price.value='';
  const mf=document.getElementById('manual-add-form');if(mf)mf.style.display='none';
  loadKeys();
  setTimeout(()=>document.getElementById('m-search')?.focus(),200);
}
function closeModal(){document.getElementById('moverlay').classList.remove('open');}
function resetModal(){
  selectedCompany=null;
  document.getElementById('modal-step1').style.display='block';
  document.getElementById('modal-step2').style.display='none';
  document.getElementById('search-results').style.display='none';
  const addBtn=document.getElementById('modal-add-btn');
  addBtn.disabled=true;addBtn.style.opacity='0.4';addBtn.textContent='V√§lj ett bolag f√∂rst';
  setTimeout(()=>document.getElementById('m-search')?.focus(),100);
}

function addStock(){
  if(!selectedCompany)return;
  const c=selectedCompany;
  const flag=getFlag(c.exchange,c.country);
  const s={
    id:'s'+Date.now(),
    name:c.name,
    ticker:c.ticker,
    exchange:`${c.exchange} ${flag}`,
    currency:c.currency||'',
    country:c.country||'',
    sector:c.sector||'',
    industry:c.branch||c.industry||'',
    bdInsId:c.insId||null,          // B√∂rsdata instrument ID
    bdConnected:c.source==='borsdata',
    price:document.getElementById('m-price')?.value?.trim()||'',
    thesis:'',revisions:[],risks:[],catalysts:[],notes:[],news:[],tags:[],checks:{},
    bull:'',bear:'',sell_thesis:'',sell_time:'',sell_size:'',sources:''
  };
  stocks.push(s);save();closeModal();selectedCompany=null;renderSidebar();navStock(s.id);
}
document.getElementById('moverlay').addEventListener('click',e=>{if(e.target===document.getElementById('moverlay'))closeModal();});

document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});

function boot(){renderSidebar();renderDash();}
load();
</script>
</body>
</html>
